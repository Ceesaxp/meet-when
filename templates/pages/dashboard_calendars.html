{{define "dashboard_calendars.html"}}
{{template "dashboard" .}}
{{end}}

{{define "content"}}
<div class="page-header">
    <h1>Calendars & Integrations</h1>
</div>

<div class="section">
    <h2>Connected Calendars</h2>
    <p>Connect your calendars to show your availability and automatically create events.</p>

    {{if .Data.Calendars}}
    <div class="calendar-list">
        {{range .Data.Calendars}}
        <div class="calendar-card {{if eq (printf "%s" .SyncStatus) "failed"}}calendar-card-error{{end}}">
            <div class="calendar-info">
                <div class="calendar-header">
                    <strong>{{.Name}}</strong>
                    {{if eq (printf "%s" .Provider) "google"}}<span class="badge badge-google">Google Calendar</span>
                    {{else if eq (printf "%s" .Provider) "icloud"}}<span class="badge badge-icloud">iCloud</span>
                    {{else}}<span class="badge">CalDAV</span>{{end}}
                    {{if .IsDefault}}<span class="badge badge-primary">Default</span>{{end}}
                </div>
                <div class="calendar-sync-status">
                    {{if eq (printf "%s" .SyncStatus) "synced"}}
                        <span class="sync-indicator sync-ok" title="Sync successful">&#10003;</span>
                        {{if .LastSyncedAt}}
                        <span class="sync-time">Last synced: {{.LastSyncedAt.Format "Jan 2, 3:04 PM"}}</span>
                        {{end}}
                    {{else if eq (printf "%s" .SyncStatus) "failed"}}
                        <span class="sync-indicator sync-error" title="Sync failed">&#9888;</span>
                        <span class="sync-time sync-error-text">Sync failed</span>
                    {{else}}
                        <span class="sync-indicator sync-unknown" title="Not synced yet">&#8635;</span>
                        <span class="sync-time">Not synced yet</span>
                    {{end}}
                </div>
                {{if and (eq (printf "%s" .SyncStatus) "failed") .SyncError}}
                <div class="calendar-error-message">
                    <span class="error-icon">&#9888;</span>
                    <span class="error-text">{{.SyncError}}</span>
                </div>
                {{end}}
            </div>
            <div class="calendar-actions">
                <form action="/dashboard/calendars/{{.ID}}/refresh" method="POST" style="display:inline">
                    <button type="submit" class="btn btn-sm" title="Refresh sync status">&#8635; Refresh</button>
                </form>
                {{if not .IsDefault}}
                <form action="/dashboard/calendars/{{.ID}}/default" method="POST" style="display:inline">
                    <button type="submit" class="btn btn-sm">Set Default</button>
                </form>
                {{end}}
                <form action="/dashboard/calendars/{{.ID}}/disconnect" method="POST" style="display:inline">
                    <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Disconnect this calendar?')">Disconnect</button>
                </form>
            </div>
        </div>
        {{end}}
    </div>
    {{else}}
    <p class="empty-state">No calendars connected yet.</p>
    {{end}}

    <div class="connect-options">
        <h3>Connect a Calendar</h3>
        <div class="connect-buttons">
            <a href="{{.Data.GoogleAuthURL}}" class="btn btn-google">Connect Google Calendar</a>
        </div>

        <details class="caldav-form icloud-form">
            <summary>Connect iCloud Calendar</summary>
            <div class="icloud-instructions">
                <p><strong>To connect iCloud Calendar, you'll need an app-specific password:</strong></p>
                <ol>
                    <li>Go to <a href="https://appleid.apple.com/account/manage" target="_blank" rel="noopener">appleid.apple.com</a></li>
                    <li>Sign in with your Apple ID</li>
                    <li>In the "Sign-In and Security" section, click "App-Specific Passwords"</li>
                    <li>Click the "+" button to generate a new password</li>
                    <li>Name it something like "Meet-When Calendar"</li>
                    <li>Copy the generated password and paste it below</li>
                </ol>
            </div>
            <form method="POST" action="/dashboard/calendars/connect/caldav" class="form">
                <input type="hidden" name="provider" value="icloud">
                <div class="form-group">
                    <label for="icloud_name">Calendar Name</label>
                    <input type="text" id="icloud_name" name="name" required value="iCloud Calendar">
                </div>
                <div class="form-group">
                    <label for="icloud_url">CalDAV URL</label>
                    <input type="url" id="icloud_url" name="url" required value="https://caldav.icloud.com/">
                    <small class="form-help">Default iCloud CalDAV URL. Usually no changes needed.</small>
                </div>
                <div class="form-group">
                    <label for="icloud_username">Apple ID Email</label>
                    <input type="email" id="icloud_username" name="username" required placeholder="your.email@icloud.com">
                </div>
                <div class="form-group">
                    <label for="icloud_password">App-Specific Password</label>
                    <input type="password" id="icloud_password" name="password" required placeholder="xxxx-xxxx-xxxx-xxxx">
                    <small class="form-help">The app-specific password generated from Apple ID settings (not your Apple ID password).</small>
                </div>
                <button type="submit" class="btn btn-primary">Connect iCloud</button>
            </form>
        </details>

        <details class="caldav-form">
            <summary>Connect Other CalDAV Calendar</summary>
            <form method="POST" action="/dashboard/calendars/connect/caldav" class="form">
                <input type="hidden" name="provider" value="caldav">
                <div class="form-group">
                    <label for="caldav_name">Calendar Name</label>
                    <input type="text" id="caldav_name" name="name" required placeholder="My Calendar">
                </div>
                <div class="form-group">
                    <label for="caldav_url">CalDAV URL</label>
                    <input type="url" id="caldav_url" name="url" required placeholder="https://caldav.example.com/calendars/user/">
                </div>
                <div class="form-group">
                    <label for="caldav_username">Username</label>
                    <input type="text" id="caldav_username" name="username" required>
                </div>
                <div class="form-group">
                    <label for="caldav_password">Password / App Password</label>
                    <input type="password" id="caldav_password" name="password" required>
                </div>
                <button type="submit" class="btn btn-primary">Connect CalDAV</button>
            </form>
        </details>
    </div>
</div>

<div class="section">
    <h2>Video Conferencing</h2>
    <p>Connect video conferencing providers to automatically create meeting links.</p>

    <div class="conferencing-list">
        {{$hasZoom := false}}
        {{range .Data.Conferencing}}
            {{if eq .Provider "zoom"}}{{$hasZoom = true}}{{end}}
        {{end}}

        <div class="conferencing-card">
            <div class="conferencing-info">
                <strong>Google Meet</strong>
                <span class="badge badge-success">Via Google Calendar</span>
            </div>
            <small>Google Meet links are created automatically when using Google Calendar</small>
        </div>

        <div class="conferencing-card">
            <div class="conferencing-info">
                <strong>Zoom</strong>
                {{if $hasZoom}}
                <span class="badge badge-success">Connected</span>
                {{else}}
                <span class="badge">Not Connected</span>
                {{end}}
            </div>
            {{if $hasZoom}}
            <form action="/dashboard/conferencing/zoom/disconnect" method="POST" style="display:inline">
                <button type="submit" class="btn btn-sm btn-danger">Disconnect</button>
            </form>
            {{else}}
            <a href="{{.Data.ZoomAuthURL}}" class="btn btn-sm">Connect Zoom</a>
            {{end}}
        </div>
    </div>
</div>
{{end}}
