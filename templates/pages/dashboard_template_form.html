{{define "dashboard_template_form.html"}}
{{template "dashboard" .}}
{{end}}

{{define "content"}}
<div class="page-header">
    <h1>{{if .Data.IsNew}}New Meeting Type{{else}}Edit Meeting Type{{end}}</h1>
</div>

<form method="POST" action="{{if .Data.IsNew}}/dashboard/templates{{else}}/dashboard/templates/{{.Data.Template.ID}}{{end}}" class="form">
    {{if not .Data.IsNew}}
    <input type="hidden" name="_method" value="PUT">
    {{end}}

    <div class="form-section">
        <h3>Basic Information</h3>

        <div class="form-group">
            <label for="name">Name</label>
            <input type="text" id="name" name="name" required
                   value="{{if .Data.Template}}{{.Data.Template.Name}}{{end}}"
                   placeholder="30 Minute Meeting">
        </div>

        <div class="form-group">
            <label for="slug">URL Slug</label>
            <input type="text" id="slug" name="slug" required pattern="[a-z0-9-]+"
                   value="{{if .Data.Template}}{{.Data.Template.Slug}}{{end}}"
                   placeholder="30-minute-meeting">
            <small>Only lowercase letters, numbers, and hyphens</small>
        </div>

        <div class="form-group">
            <label for="description">Description</label>
            <textarea id="description" name="description" rows="3"
                      placeholder="A short meeting to discuss...">{{if .Data.Template}}{{.Data.Template.Description}}{{end}}</textarea>
        </div>
    </div>

    <div class="form-section">
        <h3>Duration & Scheduling</h3>

        <div class="form-group">
            <label>Duration (minutes)</label>
            <div class="checkbox-group">
                <label><input type="checkbox" name="durations" value="15" {{if .Data.Template}}{{if contains .Data.Template.Durations 15}}checked{{end}}{{end}}> 15 min</label>
                <label><input type="checkbox" name="durations" value="30" {{if .Data.Template}}{{if contains .Data.Template.Durations 30}}checked{{end}}{{else}}checked{{end}}> 30 min</label>
                <label><input type="checkbox" name="durations" value="45" {{if .Data.Template}}{{if contains .Data.Template.Durations 45}}checked{{end}}{{end}}> 45 min</label>
                <label><input type="checkbox" name="durations" value="60" {{if .Data.Template}}{{if contains .Data.Template.Durations 60}}checked{{end}}{{end}}> 60 min</label>
            </div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label for="min_notice_minutes">Minimum Notice</label>
                <select id="min_notice_minutes" name="min_notice_minutes">
                    <option value="0" {{if .Data.Template}}{{if eq .Data.Template.MinNoticeMinutes 0}}selected{{end}}{{end}}>No minimum</option>
                    <option value="60" {{if .Data.Template}}{{if eq .Data.Template.MinNoticeMinutes 60}}selected{{end}}{{else}}selected{{end}}>1 hour</option>
                    <option value="120" {{if .Data.Template}}{{if eq .Data.Template.MinNoticeMinutes 120}}selected{{end}}{{end}}>2 hours</option>
                    <option value="240" {{if .Data.Template}}{{if eq .Data.Template.MinNoticeMinutes 240}}selected{{end}}{{end}}>4 hours</option>
                    <option value="1440" {{if .Data.Template}}{{if eq .Data.Template.MinNoticeMinutes 1440}}selected{{end}}{{end}}>1 day</option>
                </select>
            </div>

            <div class="form-group">
                <label for="max_schedule_days">Scheduling Window</label>
                <select id="max_schedule_days" name="max_schedule_days">
                    <option value="7" {{if .Data.Template}}{{if eq .Data.Template.MaxScheduleDays 7}}selected{{end}}{{end}}>1 week</option>
                    <option value="14" {{if .Data.Template}}{{if eq .Data.Template.MaxScheduleDays 14}}selected{{end}}{{else}}selected{{end}}>2 weeks</option>
                    <option value="30" {{if .Data.Template}}{{if eq .Data.Template.MaxScheduleDays 30}}selected{{end}}{{end}}>1 month</option>
                    <option value="60" {{if .Data.Template}}{{if eq .Data.Template.MaxScheduleDays 60}}selected{{end}}{{end}}>2 months</option>
                    <option value="90" {{if .Data.Template}}{{if eq .Data.Template.MaxScheduleDays 90}}selected{{end}}{{end}}>3 months</option>
                </select>
            </div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label for="pre_buffer_minutes">Buffer Before</label>
                <select id="pre_buffer_minutes" name="pre_buffer_minutes">
                    <option value="0" {{if .Data.Template}}{{if eq .Data.Template.PreBufferMinutes 0}}selected{{end}}{{else}}selected{{end}}>None</option>
                    <option value="5" {{if .Data.Template}}{{if eq .Data.Template.PreBufferMinutes 5}}selected{{end}}{{end}}>5 min</option>
                    <option value="10" {{if .Data.Template}}{{if eq .Data.Template.PreBufferMinutes 10}}selected{{end}}{{end}}>10 min</option>
                    <option value="15" {{if .Data.Template}}{{if eq .Data.Template.PreBufferMinutes 15}}selected{{end}}{{end}}>15 min</option>
                    <option value="30" {{if .Data.Template}}{{if eq .Data.Template.PreBufferMinutes 30}}selected{{end}}{{end}}>30 min</option>
                </select>
            </div>

            <div class="form-group">
                <label for="post_buffer_minutes">Buffer After</label>
                <select id="post_buffer_minutes" name="post_buffer_minutes">
                    <option value="0" {{if .Data.Template}}{{if eq .Data.Template.PostBufferMinutes 0}}selected{{end}}{{else}}selected{{end}}>None</option>
                    <option value="5" {{if .Data.Template}}{{if eq .Data.Template.PostBufferMinutes 5}}selected{{end}}{{end}}>5 min</option>
                    <option value="10" {{if .Data.Template}}{{if eq .Data.Template.PostBufferMinutes 10}}selected{{end}}{{end}}>10 min</option>
                    <option value="15" {{if .Data.Template}}{{if eq .Data.Template.PostBufferMinutes 15}}selected{{end}}{{end}}>15 min</option>
                    <option value="30" {{if .Data.Template}}{{if eq .Data.Template.PostBufferMinutes 30}}selected{{end}}{{end}}>30 min</option>
                </select>
            </div>
        </div>
    </div>

    <div class="form-section">
        <h3>Location</h3>

        <div class="form-group">
            <label for="location_type">Meeting Location</label>
            <select id="location_type" name="location_type">
                <option value="google_meet" {{if .Data.Template}}{{if eq .Data.Template.LocationType "google_meet"}}selected{{end}}{{else}}selected{{end}}>Google Meet</option>
                <option value="zoom" {{if .Data.Template}}{{if eq .Data.Template.LocationType "zoom"}}selected{{end}}{{end}}>Zoom</option>
                <option value="phone" {{if .Data.Template}}{{if eq .Data.Template.LocationType "phone"}}selected{{end}}{{end}}>Phone Call</option>
                <option value="custom" {{if .Data.Template}}{{if eq .Data.Template.LocationType "custom"}}selected{{end}}{{end}}>Custom</option>
            </select>
        </div>

        <div class="form-group" id="custom_location_group" style="{{if .Data.Template}}{{if or (eq .Data.Template.LocationType "phone") (eq .Data.Template.LocationType "custom")}}{{else}}display:none{{end}}{{else}}display:none{{end}}">
            <label for="custom_location" id="custom_location_label">{{if .Data.Template}}{{if eq .Data.Template.LocationType "phone"}}Phone Number{{else}}Location Details{{end}}{{else}}Location Details{{end}}</label>
            <input type="text" id="custom_location" name="custom_location"
                   value="{{if .Data.Template}}{{.Data.Template.CustomLocation}}{{end}}"
                   placeholder="{{if .Data.Template}}{{if eq .Data.Template.LocationType "phone"}}Enter your phone number{{else}}Address or custom location{{end}}{{else}}Address or custom location{{end}}"
                   id="custom_location_input">
            <small class="form-help" id="phone_help" style="{{if .Data.Template}}{{if eq .Data.Template.LocationType "phone"}}{{else}}display:none{{end}}{{else}}display:none{{end}}">The phone number will be displayed to invitees so they know where to call.</small>
        </div>
    </div>

    <div class="form-section">
        <h3>Calendar</h3>

        <div class="form-group">
            <label for="calendar_id">Add Event To</label>
            <select id="calendar_id" name="calendar_id">
                <option value="">Select a calendar</option>
                {{range .Data.Calendars}}
                <option value="{{.ID}}" {{if $.Data.Template}}{{if eq $.Data.Template.CalendarID .ID}}selected{{end}}{{end}}>{{.Name}} ({{.Provider}})</option>
                {{end}}
            </select>
        </div>
    </div>

    <div class="form-section">
        <h3>Booking Settings</h3>

        <div class="form-group">
            <label class="checkbox-label">
                <input type="checkbox" name="requires_approval" {{if .Data.Template}}{{if .Data.Template.RequiresApproval}}checked{{end}}{{else}}checked{{end}}>
                Require approval before confirming bookings
            </label>
        </div>

        {{if not .Data.IsNew}}
        <div class="form-group">
            <label class="checkbox-label">
                <input type="checkbox" name="is_active" {{if .Data.Template}}{{if .Data.Template.IsActive}}checked{{end}}{{else}}checked{{end}}>
                Active (visible on public page)
            </label>
        </div>
        {{end}}
    </div>

    <div class="form-section">
        <h3>Availability</h3>
        <p class="form-section-description">Restrict availability for this meeting type beyond your working hours. Leave unchecked to use your default working hours.</p>

        <div class="form-group">
            <label class="checkbox-label">
                <input type="checkbox" id="use_custom_availability" onchange="toggleCustomAvailability()">
                Use custom availability for this template
            </label>
        </div>

        <div id="availability-rules-container" style="display: none;">
            <div class="availability-days" id="availability-days-container">
                <!-- Days will be rendered by JavaScript -->
            </div>
        </div>
        <input type="hidden" name="availability_rules" id="availability_rules_json">
    </div>

    <div class="form-section">
        <h3>Custom Questions</h3>
        <p class="form-section-description">Add questions that invitees must answer when booking.</p>

        <div id="questions-container">
            <!-- Questions will be rendered here by JavaScript -->
        </div>

        <button type="button" onclick="addQuestion()" class="btn btn-sm">+ Add Question</button>
        <input type="hidden" name="invitee_questions" id="invitee_questions_json">
    </div>

    <div class="form-section">
        <h3>Email Templates</h3>
        <p class="form-section-description">Customize the emails sent to invitees. Leave blank to use default templates.</p>

        <div class="form-group">
            <label for="confirmation_email_subject">Confirmation Email Subject</label>
            <input type="text" id="confirmation_email_subject" name="confirmation_email_subject"
                   value=""
                   placeholder="e.g., Confirmed: {{"{{meeting_name}}"}} with {{"{{host_name}}"}}">
            <small>Available placeholders: <code>{{"{{invitee_name}}"}}</code>, <code>{{"{{host_name}}"}}</code>, <code>{{"{{meeting_name}}"}}</code>, <code>{{"{{meeting_time}}"}}</code>, <code>{{"{{duration}}"}}</code>, <code>{{"{{location}}"}}</code></small>
        </div>

        <div class="form-group">
            <label for="confirmation_email_body">Confirmation Email Body</label>
            <textarea id="confirmation_email_body" name="confirmation_email_body" rows="8"
                      placeholder="Hello {{"{{invitee_name}}"}},

Your meeting has been confirmed!

Meeting: {{"{{meeting_name}}"}}
With: {{"{{host_name}}"}}
When: {{"{{meeting_time}}"}}
Duration: {{"{{duration}}"}} minutes
Location: {{"{{location}}"}}

Need to make changes?
Cancel: {{"{{cancel_link}}"}}
Reschedule: {{"{{reschedule_link}}"}}

Best regards"></textarea>
            <small>Available placeholders: <code>{{"{{invitee_name}}"}}</code>, <code>{{"{{host_name}}"}}</code>, <code>{{"{{meeting_name}}"}}</code>, <code>{{"{{meeting_time}}"}}</code>, <code>{{"{{duration}}"}}</code>, <code>{{"{{location}}"}}</code>, <code>{{"{{cancel_link}}"}}</code>, <code>{{"{{reschedule_link}}"}}</code></small>
        </div>

        <hr style="margin: 1.5rem 0;">

        <div class="form-group">
            <label for="reminder_email_subject">Reminder Email Subject</label>
            <input type="text" id="reminder_email_subject" name="reminder_email_subject"
                   value=""
                   placeholder="e.g., Reminder: {{"{{meeting_name}}"}} tomorrow with {{"{{host_name}}"}}">
        </div>

        <div class="form-group">
            <label for="reminder_email_body">Reminder Email Body</label>
            <textarea id="reminder_email_body" name="reminder_email_body" rows="8"
                      placeholder="Hello {{"{{invitee_name}}"}},

This is a reminder about your upcoming meeting:

Meeting: {{"{{meeting_name}}"}}
With: {{"{{host_name}}"}}
When: {{"{{meeting_time}}"}}
Duration: {{"{{duration}}"}} minutes
Location: {{"{{location}}"}}

Need to make changes?
Cancel: {{"{{cancel_link}}"}}
Reschedule: {{"{{reschedule_link}}"}}

Best regards"></textarea>
        </div>
        <input type="hidden" name="confirmation_email" id="confirmation_email_json">
        <input type="hidden" name="reminder_email" id="reminder_email_json">
    </div>

    <div class="form-actions">
        <a href="/dashboard/templates" class="btn">Cancel</a>
        {{if not .Data.IsNew}}
        <button type="button" class="btn" onclick="document.getElementById('duplicate-form').submit()">Duplicate</button>
        {{end}}
        <button type="submit" class="btn btn-primary">{{if .Data.IsNew}}Create Meeting Type{{else}}Save Changes{{end}}</button>
    </div>
</form>

{{if not .Data.IsNew}}
<form id="duplicate-form" action="/dashboard/templates/{{.Data.Template.ID}}/duplicate" method="POST" style="display:none"></form>
{{end}}

<script>
document.getElementById('location_type').addEventListener('change', function() {
    var customGroup = document.getElementById('custom_location_group');
    var label = document.getElementById('custom_location_label');
    var input = document.getElementById('custom_location');
    var phoneHelp = document.getElementById('phone_help');

    if (this.value === 'phone') {
        customGroup.style.display = 'block';
        label.textContent = 'Phone Number';
        input.placeholder = 'Enter your phone number';
        phoneHelp.style.display = 'block';
    } else if (this.value === 'custom') {
        customGroup.style.display = 'block';
        label.textContent = 'Location Details';
        input.placeholder = 'Address or custom location';
        phoneHelp.style.display = 'none';
    } else {
        customGroup.style.display = 'none';
        phoneHelp.style.display = 'none';
    }
});

// Custom Questions Builder
var questions = [];

// Initialize questions from template data
{{if .Data.Template}}{{if .Data.Template.InviteeQuestions}}
try {
    questions = {{.Data.Template.InviteeQuestions}};
} catch (e) {
    questions = [];
}
{{end}}{{end}}

function renderQuestions() {
    var container = document.getElementById('questions-container');
    container.innerHTML = '';

    questions.forEach(function(q, index) {
        var div = document.createElement('div');
        div.className = 'question-item';
        div.innerHTML = `
            <div class="question-header">
                <span class="question-number">Question ${index + 1}</span>
                <button type="button" onclick="removeQuestion(${index})" class="btn btn-sm btn-danger">Remove</button>
            </div>
            <div class="form-group">
                <label>Question Label *</label>
                <input type="text" value="${escapeHtml(q.label || '')}" onchange="updateQuestion(${index}, 'label', this.value)" placeholder="e.g., What company are you from?" required>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Field Name *</label>
                    <input type="text" value="${escapeHtml(q.field || '')}" onchange="updateQuestion(${index}, 'field', this.value)" placeholder="e.g., company_name" pattern="[a-z0-9_]+" required>
                    <small>Lowercase letters, numbers, underscores only</small>
                </div>
                <div class="form-group">
                    <label>Type</label>
                    <select onchange="updateQuestion(${index}, 'type', this.value)">
                        <option value="text" ${q.type === 'text' ? 'selected' : ''}>Text (single line)</option>
                        <option value="textarea" ${q.type === 'textarea' ? 'selected' : ''}>Textarea (multi-line)</option>
                        <option value="select" ${q.type === 'select' ? 'selected' : ''}>Dropdown</option>
                    </select>
                </div>
            </div>
            <div class="form-group" id="options-group-${index}" style="${q.type === 'select' ? '' : 'display:none'}">
                <label>Options (one per line)</label>
                <textarea rows="3" onchange="updateQuestion(${index}, 'options', this.value.split('\\n').filter(o => o.trim()))" placeholder="Option 1\nOption 2\nOption 3">${(q.options || []).join('\\n')}</textarea>
            </div>
            <div class="form-group">
                <label class="checkbox-label">
                    <input type="checkbox" ${q.required ? 'checked' : ''} onchange="updateQuestion(${index}, 'required', this.checked)">
                    Required
                </label>
            </div>
        `;
        container.appendChild(div);
    });

    updateHiddenInput();
}

function addQuestion() {
    questions.push({
        id: 'q' + Date.now(),
        field: '',
        label: '',
        type: 'text',
        required: false,
        options: []
    });
    renderQuestions();
}

function removeQuestion(index) {
    questions.splice(index, 1);
    renderQuestions();
}

function updateQuestion(index, key, value) {
    questions[index][key] = value;

    // Show/hide options field for select type
    if (key === 'type') {
        var optionsGroup = document.getElementById('options-group-' + index);
        if (optionsGroup) {
            optionsGroup.style.display = value === 'select' ? '' : 'none';
        }
    }

    updateHiddenInput();
}

function updateHiddenInput() {
    document.getElementById('invitee_questions_json').value = JSON.stringify(questions);
}

function escapeHtml(text) {
    var div = document.createElement('div');
    div.appendChild(document.createTextNode(text));
    return div.innerHTML;
}

// Update hidden input before form submission
document.querySelector('form').addEventListener('submit', function() {
    updateHiddenInput();
    updateAvailabilityHiddenInput();
    updateEmailTemplateHiddenInputs();
});

// Availability Rules Builder
var availabilityRules = null;
var dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
var MAX_INTERVALS_PER_DAY = 2;

// Initialize availability rules from template data
{{if .Data.Template}}{{if .Data.Template.AvailabilityRules}}
try {
    availabilityRules = {{.Data.Template.AvailabilityRules}};
} catch (e) {
    availabilityRules = null;
}
{{end}}{{end}}

function toggleCustomAvailability() {
    var checkbox = document.getElementById('use_custom_availability');
    var container = document.getElementById('availability-rules-container');

    if (checkbox.checked) {
        container.style.display = 'block';
        // Initialize default rules if none exist
        if (!availabilityRules || !availabilityRules.days) {
            availabilityRules = { enabled: true, days: {} };
        }
        availabilityRules.enabled = true;
        renderAvailabilityDays();
    } else {
        container.style.display = 'none';
        if (availabilityRules) {
            availabilityRules.enabled = false;
        }
    }
    updateAvailabilityHiddenInput();
}

function renderAvailabilityDays() {
    var container = document.getElementById('availability-days-container');
    container.innerHTML = '';

    for (var day = 0; day <= 6; day++) {
        var dayData = (availabilityRules && availabilityRules.days && availabilityRules.days[day]) || null;
        var isEnabled = dayData && dayData.enabled;
        var intervals = [];

        if (dayData) {
            // Support new format (intervals array) or old format (single start/end)
            if (dayData.intervals && dayData.intervals.length > 0) {
                intervals = dayData.intervals;
            } else if (dayData.start && dayData.end) {
                intervals = [{ start: dayData.start, end: dayData.end }];
            }
        }

        // Default interval if day is enabled but no intervals exist
        if (isEnabled && intervals.length === 0) {
            intervals = [{ start: '09:00', end: '17:00' }];
        }

        var dayDiv = document.createElement('div');
        dayDiv.className = 'availability-day';
        dayDiv.setAttribute('data-day', day);

        var dayHeader = document.createElement('div');
        dayHeader.className = 'day-header';
        dayHeader.innerHTML = `
            <label class="checkbox-label">
                <input type="checkbox" class="day-enabled" data-day="${day}" onchange="toggleDay(${day})" ${isEnabled ? 'checked' : ''}>
                <span>${dayNames[day]}</span>
            </label>
        `;
        dayDiv.appendChild(dayHeader);

        var timeRangesDiv = document.createElement('div');
        timeRangesDiv.className = 'day-time-ranges';
        timeRangesDiv.id = 'day-time-ranges-' + day;
        timeRangesDiv.style.display = isEnabled ? 'block' : 'none';

        // Render intervals
        var intervalsContainer = document.createElement('div');
        intervalsContainer.className = 'intervals-container';
        intervalsContainer.id = 'intervals-container-' + day;

        if (isEnabled && intervals.length > 0) {
            intervals.forEach(function(interval, idx) {
                intervalsContainer.appendChild(createIntervalElement(day, idx, interval.start, interval.end, intervals.length));
            });
        } else {
            // Default interval for when day gets enabled
            intervalsContainer.appendChild(createIntervalElement(day, 0, '09:00', '17:00', 1));
        }

        timeRangesDiv.appendChild(intervalsContainer);

        // Add interval button (shown only if less than MAX_INTERVALS_PER_DAY intervals)
        var addIntervalBtn = document.createElement('button');
        addIntervalBtn.type = 'button';
        addIntervalBtn.className = 'btn btn-sm btn-add-interval';
        addIntervalBtn.id = 'add-interval-btn-' + day;
        addIntervalBtn.textContent = '+ Add interval';
        addIntervalBtn.onclick = function(d) {
            return function() { addInterval(d); };
        }(day);
        addIntervalBtn.style.display = (isEnabled && intervals.length < MAX_INTERVALS_PER_DAY) ? 'inline-block' : 'none';
        timeRangesDiv.appendChild(addIntervalBtn);

        dayDiv.appendChild(timeRangesDiv);
        container.appendChild(dayDiv);
    }
}

function createIntervalElement(day, index, start, end, totalIntervals) {
    var intervalDiv = document.createElement('div');
    intervalDiv.className = 'time-range';
    intervalDiv.setAttribute('data-day', day);
    intervalDiv.setAttribute('data-index', index);

    var startInput = document.createElement('input');
    startInput.type = 'time';
    startInput.className = 'interval-start';
    startInput.value = start;
    startInput.onchange = function() { updateAvailabilityRules(); };

    var toSpan = document.createElement('span');
    toSpan.textContent = 'to';

    var endInput = document.createElement('input');
    endInput.type = 'time';
    endInput.className = 'interval-end';
    endInput.value = end;
    endInput.onchange = function() { updateAvailabilityRules(); };

    intervalDiv.appendChild(startInput);
    intervalDiv.appendChild(toSpan);
    intervalDiv.appendChild(endInput);

    // Remove button (only show if more than 1 interval)
    if (totalIntervals > 1) {
        var removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.className = 'btn btn-sm btn-remove-interval';
        removeBtn.textContent = 'Remove';
        removeBtn.onclick = function(d, i) {
            return function() { removeInterval(d, i); };
        }(day, index);
        intervalDiv.appendChild(removeBtn);
    }

    return intervalDiv;
}

function toggleDay(day) {
    var checkbox = document.querySelector('.day-enabled[data-day="' + day + '"]');
    var timeRangesDiv = document.getElementById('day-time-ranges-' + day);
    var addIntervalBtn = document.getElementById('add-interval-btn-' + day);

    if (checkbox.checked) {
        timeRangesDiv.style.display = 'block';
        // Show add interval button if less than max intervals
        var intervalsContainer = document.getElementById('intervals-container-' + day);
        var currentIntervals = intervalsContainer.querySelectorAll('.time-range').length;
        addIntervalBtn.style.display = currentIntervals < MAX_INTERVALS_PER_DAY ? 'inline-block' : 'none';
    } else {
        timeRangesDiv.style.display = 'none';
    }

    updateAvailabilityRules();
}

function addInterval(day) {
    var intervalsContainer = document.getElementById('intervals-container-' + day);
    var currentIntervals = intervalsContainer.querySelectorAll('.time-range');
    var currentCount = currentIntervals.length;

    if (currentCount >= MAX_INTERVALS_PER_DAY) {
        return;
    }

    // Get smart default times based on first interval
    var firstInterval = currentIntervals[0];
    var firstStart = firstInterval.querySelector('.interval-start').value;
    var firstEnd = firstInterval.querySelector('.interval-end').value;

    var newStart, newEnd;
    // If first interval ends at or before 12:00, default to afternoon (13:00-17:00)
    if (firstEnd <= '12:00') {
        newStart = '13:00';
        newEnd = '17:00';
    } else {
        // Otherwise, start 1 hour after first interval ends, for 3 hours
        var endParts = firstEnd.split(':');
        var endHour = parseInt(endParts[0], 10);
        var endMin = parseInt(endParts[1], 10);
        var newStartHour = endHour + 1;
        var newEndHour = newStartHour + 3;
        if (newEndHour > 23) newEndHour = 23;
        newStart = String(newStartHour).padStart(2, '0') + ':' + String(endMin).padStart(2, '0');
        newEnd = String(newEndHour).padStart(2, '0') + ':' + String(endMin).padStart(2, '0');
    }

    var newIndex = currentCount;
    var newTotal = currentCount + 1;

    // Add new interval
    intervalsContainer.appendChild(createIntervalElement(day, newIndex, newStart, newEnd, newTotal));

    // Update remove buttons on existing intervals (they now need remove buttons)
    updateRemoveButtons(day);

    // Hide add interval button if we've reached max
    var addIntervalBtn = document.getElementById('add-interval-btn-' + day);
    if (newTotal >= MAX_INTERVALS_PER_DAY) {
        addIntervalBtn.style.display = 'none';
    }

    updateAvailabilityRules();
}

function removeInterval(day, index) {
    var intervalsContainer = document.getElementById('intervals-container-' + day);
    var intervals = intervalsContainer.querySelectorAll('.time-range');

    if (intervals.length <= 1) {
        return; // Can't remove the last interval
    }

    // Remove the interval at the given index
    intervals[index].remove();

    // Re-index remaining intervals and update remove buttons
    updateRemoveButtons(day);

    // Show add interval button
    var addIntervalBtn = document.getElementById('add-interval-btn-' + day);
    addIntervalBtn.style.display = 'inline-block';

    updateAvailabilityRules();
}

function updateRemoveButtons(day) {
    var intervalsContainer = document.getElementById('intervals-container-' + day);
    var intervals = intervalsContainer.querySelectorAll('.time-range');
    var totalIntervals = intervals.length;

    intervals.forEach(function(interval, idx) {
        interval.setAttribute('data-index', idx);

        // Remove existing remove button if any
        var existingBtn = interval.querySelector('.btn-remove-interval');
        if (existingBtn) {
            existingBtn.remove();
        }

        // Add remove button if more than 1 interval
        if (totalIntervals > 1) {
            var removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.className = 'btn btn-sm btn-remove-interval';
            removeBtn.textContent = 'Remove';
            removeBtn.onclick = function(d, i) {
                return function() { removeInterval(d, i); };
            }(day, idx);
            interval.appendChild(removeBtn);
        }
    });
}

function updateAvailabilityRules() {
    if (!availabilityRules) {
        availabilityRules = { enabled: true, days: {} };
    }

    var days = {};
    for (var day = 0; day <= 6; day++) {
        var enabledCheckbox = document.querySelector('.day-enabled[data-day="' + day + '"]');

        if (enabledCheckbox && enabledCheckbox.checked) {
            var intervalsContainer = document.getElementById('intervals-container-' + day);
            var intervalElements = intervalsContainer.querySelectorAll('.time-range');
            var intervals = [];

            intervalElements.forEach(function(el) {
                var start = el.querySelector('.interval-start').value;
                var end = el.querySelector('.interval-end').value;
                if (start && end) {
                    intervals.push({ start: start, end: end });
                }
            });

            days[day] = {
                enabled: true,
                intervals: intervals
            };
        }
    }

    availabilityRules.days = days;
    updateAvailabilityHiddenInput();
}

function updateAvailabilityHiddenInput() {
    var input = document.getElementById('availability_rules_json');
    var checkbox = document.getElementById('use_custom_availability');

    if (checkbox.checked && availabilityRules) {
        input.value = JSON.stringify(availabilityRules);
    } else {
        input.value = '';
    }
}

function initializeAvailabilityRules() {
    // Render the days first
    renderAvailabilityDays();

    if (availabilityRules && availabilityRules.enabled) {
        // Enable custom availability checkbox
        document.getElementById('use_custom_availability').checked = true;
        document.getElementById('availability-rules-container').style.display = 'block';
        // Re-render with the actual data
        renderAvailabilityDays();
    }
    updateAvailabilityHiddenInput();
}

// Email Templates Handler
var confirmationEmail = null;
var reminderEmail = null;

// Initialize email templates from template data
{{if .Data.Template}}{{if .Data.Template.ConfirmationEmail}}
try {
    confirmationEmail = JSON.parse({{.Data.Template.ConfirmationEmail}});
} catch (e) {
    confirmationEmail = null;
}
{{end}}{{end}}

{{if .Data.Template}}{{if .Data.Template.ReminderEmail}}
try {
    reminderEmail = JSON.parse({{.Data.Template.ReminderEmail}});
} catch (e) {
    reminderEmail = null;
}
{{end}}{{end}}

function initializeEmailTemplates() {
    if (confirmationEmail) {
        document.getElementById('confirmation_email_subject').value = confirmationEmail.subject || '';
        document.getElementById('confirmation_email_body').value = confirmationEmail.body || '';
    }
    if (reminderEmail) {
        document.getElementById('reminder_email_subject').value = reminderEmail.subject || '';
        document.getElementById('reminder_email_body').value = reminderEmail.body || '';
    }
}

function updateEmailTemplateHiddenInputs() {
    var confirmSubject = document.getElementById('confirmation_email_subject').value.trim();
    var confirmBody = document.getElementById('confirmation_email_body').value.trim();
    var reminderSubject = document.getElementById('reminder_email_subject').value.trim();
    var reminderBody = document.getElementById('reminder_email_body').value.trim();

    // Only set JSON if at least one field has content
    if (confirmSubject || confirmBody) {
        document.getElementById('confirmation_email_json').value = JSON.stringify({
            subject: confirmSubject,
            body: confirmBody
        });
    } else {
        document.getElementById('confirmation_email_json').value = '';
    }

    if (reminderSubject || reminderBody) {
        document.getElementById('reminder_email_json').value = JSON.stringify({
            subject: reminderSubject,
            body: reminderBody
        });
    } else {
        document.getElementById('reminder_email_json').value = '';
    }
}

// Initialize availability on page load (after renderQuestions)
document.addEventListener('DOMContentLoaded', function() {
    renderQuestions();
    initializeAvailabilityRules();
    initializeEmailTemplates();
});
</script>
{{end}}
