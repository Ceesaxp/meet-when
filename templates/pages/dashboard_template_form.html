{{define "dashboard_template_form.html"}}
{{template "dashboard" .}}
{{end}}

{{define "content"}}
<div class="page-header">
    <h1>{{if .Data.IsNew}}New Meeting Type{{else}}Edit Meeting Type{{end}}</h1>
</div>

<form method="POST" action="{{if .Data.IsNew}}/dashboard/templates{{else}}/dashboard/templates/{{.Data.Template.ID}}{{end}}" class="form">
    {{if not .Data.IsNew}}
    <input type="hidden" name="_method" value="PUT">
    {{end}}

    <div class="form-section">
        <h3>Basic Information</h3>

        <div class="form-group">
            <label for="name">Name</label>
            <input type="text" id="name" name="name" required
                   value="{{if .Data.Template}}{{.Data.Template.Name}}{{end}}"
                   placeholder="30 Minute Meeting">
        </div>

        <div class="form-group">
            <label for="slug">URL Slug</label>
            <input type="text" id="slug" name="slug" required pattern="[a-z0-9-]+"
                   value="{{if .Data.Template}}{{.Data.Template.Slug}}{{end}}"
                   placeholder="30-minute-meeting">
            <small>Only lowercase letters, numbers, and hyphens</small>
        </div>

        <div class="form-group">
            <label for="description">Description</label>
            <textarea id="description" name="description" rows="3"
                      placeholder="A short meeting to discuss...">{{if .Data.Template}}{{.Data.Template.Description}}{{end}}</textarea>
        </div>
    </div>

    <div class="form-section">
        <h3>Duration & Scheduling</h3>

        <div class="form-group">
            <label>Duration (minutes)</label>
            <div class="checkbox-group">
                <label><input type="checkbox" name="durations" value="15" {{if .Data.Template}}{{if contains .Data.Template.Durations 15}}checked{{end}}{{end}}> 15 min</label>
                <label><input type="checkbox" name="durations" value="30" {{if .Data.Template}}{{if contains .Data.Template.Durations 30}}checked{{end}}{{else}}checked{{end}}> 30 min</label>
                <label><input type="checkbox" name="durations" value="45" {{if .Data.Template}}{{if contains .Data.Template.Durations 45}}checked{{end}}{{end}}> 45 min</label>
                <label><input type="checkbox" name="durations" value="60" {{if .Data.Template}}{{if contains .Data.Template.Durations 60}}checked{{end}}{{end}}> 60 min</label>
            </div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label for="min_notice_minutes">Minimum Notice</label>
                <select id="min_notice_minutes" name="min_notice_minutes">
                    <option value="0" {{if .Data.Template}}{{if eq .Data.Template.MinNoticeMinutes 0}}selected{{end}}{{end}}>No minimum</option>
                    <option value="60" {{if .Data.Template}}{{if eq .Data.Template.MinNoticeMinutes 60}}selected{{end}}{{else}}selected{{end}}>1 hour</option>
                    <option value="120" {{if .Data.Template}}{{if eq .Data.Template.MinNoticeMinutes 120}}selected{{end}}{{end}}>2 hours</option>
                    <option value="240" {{if .Data.Template}}{{if eq .Data.Template.MinNoticeMinutes 240}}selected{{end}}{{end}}>4 hours</option>
                    <option value="1440" {{if .Data.Template}}{{if eq .Data.Template.MinNoticeMinutes 1440}}selected{{end}}{{end}}>1 day</option>
                </select>
            </div>

            <div class="form-group">
                <label for="max_schedule_days">Scheduling Window</label>
                <select id="max_schedule_days" name="max_schedule_days">
                    <option value="7" {{if .Data.Template}}{{if eq .Data.Template.MaxScheduleDays 7}}selected{{end}}{{end}}>1 week</option>
                    <option value="14" {{if .Data.Template}}{{if eq .Data.Template.MaxScheduleDays 14}}selected{{end}}{{else}}selected{{end}}>2 weeks</option>
                    <option value="30" {{if .Data.Template}}{{if eq .Data.Template.MaxScheduleDays 30}}selected{{end}}{{end}}>1 month</option>
                    <option value="60" {{if .Data.Template}}{{if eq .Data.Template.MaxScheduleDays 60}}selected{{end}}{{end}}>2 months</option>
                    <option value="90" {{if .Data.Template}}{{if eq .Data.Template.MaxScheduleDays 90}}selected{{end}}{{end}}>3 months</option>
                </select>
            </div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label for="pre_buffer_minutes">Buffer Before</label>
                <select id="pre_buffer_minutes" name="pre_buffer_minutes">
                    <option value="0" {{if .Data.Template}}{{if eq .Data.Template.PreBufferMinutes 0}}selected{{end}}{{else}}selected{{end}}>None</option>
                    <option value="5" {{if .Data.Template}}{{if eq .Data.Template.PreBufferMinutes 5}}selected{{end}}{{end}}>5 min</option>
                    <option value="10" {{if .Data.Template}}{{if eq .Data.Template.PreBufferMinutes 10}}selected{{end}}{{end}}>10 min</option>
                    <option value="15" {{if .Data.Template}}{{if eq .Data.Template.PreBufferMinutes 15}}selected{{end}}{{end}}>15 min</option>
                    <option value="30" {{if .Data.Template}}{{if eq .Data.Template.PreBufferMinutes 30}}selected{{end}}{{end}}>30 min</option>
                </select>
            </div>

            <div class="form-group">
                <label for="post_buffer_minutes">Buffer After</label>
                <select id="post_buffer_minutes" name="post_buffer_minutes">
                    <option value="0" {{if .Data.Template}}{{if eq .Data.Template.PostBufferMinutes 0}}selected{{end}}{{else}}selected{{end}}>None</option>
                    <option value="5" {{if .Data.Template}}{{if eq .Data.Template.PostBufferMinutes 5}}selected{{end}}{{end}}>5 min</option>
                    <option value="10" {{if .Data.Template}}{{if eq .Data.Template.PostBufferMinutes 10}}selected{{end}}{{end}}>10 min</option>
                    <option value="15" {{if .Data.Template}}{{if eq .Data.Template.PostBufferMinutes 15}}selected{{end}}{{end}}>15 min</option>
                    <option value="30" {{if .Data.Template}}{{if eq .Data.Template.PostBufferMinutes 30}}selected{{end}}{{end}}>30 min</option>
                </select>
            </div>
        </div>
    </div>

    <div class="form-section">
        <h3>Location</h3>

        <div class="form-group">
            <label for="location_type">Meeting Location</label>
            <select id="location_type" name="location_type">
                <option value="google_meet" {{if .Data.Template}}{{if eq .Data.Template.LocationType "google_meet"}}selected{{end}}{{else}}selected{{end}}>Google Meet</option>
                <option value="zoom" {{if .Data.Template}}{{if eq .Data.Template.LocationType "zoom"}}selected{{end}}{{end}}>Zoom</option>
                <option value="phone" {{if .Data.Template}}{{if eq .Data.Template.LocationType "phone"}}selected{{end}}{{end}}>Phone Call</option>
                <option value="custom" {{if .Data.Template}}{{if eq .Data.Template.LocationType "custom"}}selected{{end}}{{end}}>Custom</option>
            </select>
        </div>

        <div class="form-group" id="custom_location_group" style="{{if .Data.Template}}{{if or (eq .Data.Template.LocationType "phone") (eq .Data.Template.LocationType "custom")}}{{else}}display:none{{end}}{{else}}display:none{{end}}">
            <label for="custom_location" id="custom_location_label">{{if .Data.Template}}{{if eq .Data.Template.LocationType "phone"}}Phone Number{{else}}Location Details{{end}}{{else}}Location Details{{end}}</label>
            <input type="text" id="custom_location" name="custom_location"
                   value="{{if .Data.Template}}{{.Data.Template.CustomLocation}}{{end}}"
                   placeholder="{{if .Data.Template}}{{if eq .Data.Template.LocationType "phone"}}Enter your phone number{{else}}Address or custom location{{end}}{{else}}Address or custom location{{end}}"
                   id="custom_location_input">
            <small class="form-help" id="phone_help" style="{{if .Data.Template}}{{if eq .Data.Template.LocationType "phone"}}{{else}}display:none{{end}}{{else}}display:none{{end}}">The phone number will be displayed to invitees so they know where to call.</small>
        </div>
    </div>

    <div class="form-section">
        <h3>Calendar</h3>

        <div class="form-group">
            <label for="calendar_id">Add Event To</label>
            <select id="calendar_id" name="calendar_id">
                <option value="">Select a calendar</option>
                {{range .Data.Calendars}}
                <option value="{{.ID}}" {{if $.Data.Template}}{{if eq $.Data.Template.CalendarID .ID}}selected{{end}}{{end}}>{{.Name}} ({{.Provider}})</option>
                {{end}}
            </select>
        </div>
    </div>

    <div class="form-section">
        <h3>Booking Settings</h3>

        <div class="form-group">
            <label class="checkbox-label">
                <input type="checkbox" name="requires_approval" {{if .Data.Template}}{{if .Data.Template.RequiresApproval}}checked{{end}}{{else}}checked{{end}}>
                Require approval before confirming bookings
            </label>
        </div>

        {{if not .Data.IsNew}}
        <div class="form-group">
            <label class="checkbox-label">
                <input type="checkbox" name="is_active" {{if .Data.Template}}{{if .Data.Template.IsActive}}checked{{end}}{{else}}checked{{end}}>
                Active (visible on public page)
            </label>
        </div>
        {{end}}
    </div>

    <div class="form-section">
        <h3>Availability</h3>
        <p class="form-section-description">Restrict availability for this meeting type beyond your working hours. Leave unchecked to use your default working hours.</p>

        <div class="form-group">
            <label class="checkbox-label">
                <input type="checkbox" id="use_custom_availability" onchange="toggleCustomAvailability()">
                Use custom availability for this template
            </label>
        </div>

        <div id="availability-rules-container" style="display: none;">
            <div class="availability-days">
                <div class="availability-day" data-day="0">
                    <label class="checkbox-label">
                        <input type="checkbox" class="day-enabled" data-day="0" onchange="updateAvailabilityRules()">
                        <span>Sunday</span>
                    </label>
                    <div class="day-time-ranges" style="display: none;">
                        <div class="time-range">
                            <input type="time" class="day-start" data-day="0" value="09:00" onchange="updateAvailabilityRules()">
                            <span>to</span>
                            <input type="time" class="day-end" data-day="0" value="17:00" onchange="updateAvailabilityRules()">
                        </div>
                    </div>
                </div>
                <div class="availability-day" data-day="1">
                    <label class="checkbox-label">
                        <input type="checkbox" class="day-enabled" data-day="1" onchange="updateAvailabilityRules()">
                        <span>Monday</span>
                    </label>
                    <div class="day-time-ranges" style="display: none;">
                        <div class="time-range">
                            <input type="time" class="day-start" data-day="1" value="09:00" onchange="updateAvailabilityRules()">
                            <span>to</span>
                            <input type="time" class="day-end" data-day="1" value="17:00" onchange="updateAvailabilityRules()">
                        </div>
                    </div>
                </div>
                <div class="availability-day" data-day="2">
                    <label class="checkbox-label">
                        <input type="checkbox" class="day-enabled" data-day="2" onchange="updateAvailabilityRules()">
                        <span>Tuesday</span>
                    </label>
                    <div class="day-time-ranges" style="display: none;">
                        <div class="time-range">
                            <input type="time" class="day-start" data-day="2" value="09:00" onchange="updateAvailabilityRules()">
                            <span>to</span>
                            <input type="time" class="day-end" data-day="2" value="17:00" onchange="updateAvailabilityRules()">
                        </div>
                    </div>
                </div>
                <div class="availability-day" data-day="3">
                    <label class="checkbox-label">
                        <input type="checkbox" class="day-enabled" data-day="3" onchange="updateAvailabilityRules()">
                        <span>Wednesday</span>
                    </label>
                    <div class="day-time-ranges" style="display: none;">
                        <div class="time-range">
                            <input type="time" class="day-start" data-day="3" value="09:00" onchange="updateAvailabilityRules()">
                            <span>to</span>
                            <input type="time" class="day-end" data-day="3" value="17:00" onchange="updateAvailabilityRules()">
                        </div>
                    </div>
                </div>
                <div class="availability-day" data-day="4">
                    <label class="checkbox-label">
                        <input type="checkbox" class="day-enabled" data-day="4" onchange="updateAvailabilityRules()">
                        <span>Thursday</span>
                    </label>
                    <div class="day-time-ranges" style="display: none;">
                        <div class="time-range">
                            <input type="time" class="day-start" data-day="4" value="09:00" onchange="updateAvailabilityRules()">
                            <span>to</span>
                            <input type="time" class="day-end" data-day="4" value="17:00" onchange="updateAvailabilityRules()">
                        </div>
                    </div>
                </div>
                <div class="availability-day" data-day="5">
                    <label class="checkbox-label">
                        <input type="checkbox" class="day-enabled" data-day="5" onchange="updateAvailabilityRules()">
                        <span>Friday</span>
                    </label>
                    <div class="day-time-ranges" style="display: none;">
                        <div class="time-range">
                            <input type="time" class="day-start" data-day="5" value="09:00" onchange="updateAvailabilityRules()">
                            <span>to</span>
                            <input type="time" class="day-end" data-day="5" value="17:00" onchange="updateAvailabilityRules()">
                        </div>
                    </div>
                </div>
                <div class="availability-day" data-day="6">
                    <label class="checkbox-label">
                        <input type="checkbox" class="day-enabled" data-day="6" onchange="updateAvailabilityRules()">
                        <span>Saturday</span>
                    </label>
                    <div class="day-time-ranges" style="display: none;">
                        <div class="time-range">
                            <input type="time" class="day-start" data-day="6" value="09:00" onchange="updateAvailabilityRules()">
                            <span>to</span>
                            <input type="time" class="day-end" data-day="6" value="17:00" onchange="updateAvailabilityRules()">
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <input type="hidden" name="availability_rules" id="availability_rules_json">
    </div>

    <div class="form-section">
        <h3>Custom Questions</h3>
        <p class="form-section-description">Add questions that invitees must answer when booking.</p>

        <div id="questions-container">
            <!-- Questions will be rendered here by JavaScript -->
        </div>

        <button type="button" onclick="addQuestion()" class="btn btn-sm">+ Add Question</button>
        <input type="hidden" name="invitee_questions" id="invitee_questions_json">
    </div>

    <div class="form-section">
        <h3>Email Templates</h3>
        <p class="form-section-description">Customize the emails sent to invitees. Leave blank to use default templates.</p>

        <div class="form-group">
            <label for="confirmation_email_subject">Confirmation Email Subject</label>
            <input type="text" id="confirmation_email_subject" name="confirmation_email_subject"
                   value=""
                   placeholder="e.g., Confirmed: {{meeting_name}} with {{host_name}}">
            <small>Available placeholders: <code>{{invitee_name}}</code>, <code>{{host_name}}</code>, <code>{{meeting_name}}</code>, <code>{{meeting_time}}</code>, <code>{{duration}}</code>, <code>{{location}}</code></small>
        </div>

        <div class="form-group">
            <label for="confirmation_email_body">Confirmation Email Body</label>
            <textarea id="confirmation_email_body" name="confirmation_email_body" rows="8"
                      placeholder="Hello {{invitee_name}},

Your meeting has been confirmed!

Meeting: {{meeting_name}}
With: {{host_name}}
When: {{meeting_time}}
Duration: {{duration}} minutes
Location: {{location}}

Need to make changes?
Cancel: {{cancel_link}}
Reschedule: {{reschedule_link}}

Best regards"></textarea>
            <small>Available placeholders: <code>{{invitee_name}}</code>, <code>{{host_name}}</code>, <code>{{meeting_name}}</code>, <code>{{meeting_time}}</code>, <code>{{duration}}</code>, <code>{{location}}</code>, <code>{{cancel_link}}</code>, <code>{{reschedule_link}}</code></small>
        </div>

        <hr style="margin: 1.5rem 0;">

        <div class="form-group">
            <label for="reminder_email_subject">Reminder Email Subject</label>
            <input type="text" id="reminder_email_subject" name="reminder_email_subject"
                   value=""
                   placeholder="e.g., Reminder: {{meeting_name}} tomorrow with {{host_name}}">
        </div>

        <div class="form-group">
            <label for="reminder_email_body">Reminder Email Body</label>
            <textarea id="reminder_email_body" name="reminder_email_body" rows="8"
                      placeholder="Hello {{invitee_name}},

This is a reminder about your upcoming meeting:

Meeting: {{meeting_name}}
With: {{host_name}}
When: {{meeting_time}}
Duration: {{duration}} minutes
Location: {{location}}

Need to make changes?
Cancel: {{cancel_link}}
Reschedule: {{reschedule_link}}

Best regards"></textarea>
        </div>
        <input type="hidden" name="confirmation_email" id="confirmation_email_json">
        <input type="hidden" name="reminder_email" id="reminder_email_json">
    </div>

    <div class="form-actions">
        <a href="/dashboard/templates" class="btn">Cancel</a>
        <button type="submit" class="btn btn-primary">{{if .Data.IsNew}}Create Meeting Type{{else}}Save Changes{{end}}</button>
    </div>
</form>

<script>
document.getElementById('location_type').addEventListener('change', function() {
    var customGroup = document.getElementById('custom_location_group');
    var label = document.getElementById('custom_location_label');
    var input = document.getElementById('custom_location');
    var phoneHelp = document.getElementById('phone_help');

    if (this.value === 'phone') {
        customGroup.style.display = 'block';
        label.textContent = 'Phone Number';
        input.placeholder = 'Enter your phone number';
        phoneHelp.style.display = 'block';
    } else if (this.value === 'custom') {
        customGroup.style.display = 'block';
        label.textContent = 'Location Details';
        input.placeholder = 'Address or custom location';
        phoneHelp.style.display = 'none';
    } else {
        customGroup.style.display = 'none';
        phoneHelp.style.display = 'none';
    }
});

// Custom Questions Builder
var questions = [];

// Initialize questions from template data
{{if .Data.Template}}{{if .Data.Template.InviteeQuestions}}
try {
    questions = {{.Data.Template.InviteeQuestions}};
} catch (e) {
    questions = [];
}
{{end}}{{end}}

function renderQuestions() {
    var container = document.getElementById('questions-container');
    container.innerHTML = '';

    questions.forEach(function(q, index) {
        var div = document.createElement('div');
        div.className = 'question-item';
        div.innerHTML = `
            <div class="question-header">
                <span class="question-number">Question ${index + 1}</span>
                <button type="button" onclick="removeQuestion(${index})" class="btn btn-sm btn-danger">Remove</button>
            </div>
            <div class="form-group">
                <label>Question Label *</label>
                <input type="text" value="${escapeHtml(q.label || '')}" onchange="updateQuestion(${index}, 'label', this.value)" placeholder="e.g., What company are you from?" required>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Field Name *</label>
                    <input type="text" value="${escapeHtml(q.field || '')}" onchange="updateQuestion(${index}, 'field', this.value)" placeholder="e.g., company_name" pattern="[a-z0-9_]+" required>
                    <small>Lowercase letters, numbers, underscores only</small>
                </div>
                <div class="form-group">
                    <label>Type</label>
                    <select onchange="updateQuestion(${index}, 'type', this.value)">
                        <option value="text" ${q.type === 'text' ? 'selected' : ''}>Text (single line)</option>
                        <option value="textarea" ${q.type === 'textarea' ? 'selected' : ''}>Textarea (multi-line)</option>
                        <option value="select" ${q.type === 'select' ? 'selected' : ''}>Dropdown</option>
                    </select>
                </div>
            </div>
            <div class="form-group" id="options-group-${index}" style="${q.type === 'select' ? '' : 'display:none'}">
                <label>Options (one per line)</label>
                <textarea rows="3" onchange="updateQuestion(${index}, 'options', this.value.split('\\n').filter(o => o.trim()))" placeholder="Option 1\nOption 2\nOption 3">${(q.options || []).join('\\n')}</textarea>
            </div>
            <div class="form-group">
                <label class="checkbox-label">
                    <input type="checkbox" ${q.required ? 'checked' : ''} onchange="updateQuestion(${index}, 'required', this.checked)">
                    Required
                </label>
            </div>
        `;
        container.appendChild(div);
    });

    updateHiddenInput();
}

function addQuestion() {
    questions.push({
        id: 'q' + Date.now(),
        field: '',
        label: '',
        type: 'text',
        required: false,
        options: []
    });
    renderQuestions();
}

function removeQuestion(index) {
    questions.splice(index, 1);
    renderQuestions();
}

function updateQuestion(index, key, value) {
    questions[index][key] = value;

    // Show/hide options field for select type
    if (key === 'type') {
        var optionsGroup = document.getElementById('options-group-' + index);
        if (optionsGroup) {
            optionsGroup.style.display = value === 'select' ? '' : 'none';
        }
    }

    updateHiddenInput();
}

function updateHiddenInput() {
    document.getElementById('invitee_questions_json').value = JSON.stringify(questions);
}

function escapeHtml(text) {
    var div = document.createElement('div');
    div.appendChild(document.createTextNode(text));
    return div.innerHTML;
}

// Update hidden input before form submission
document.querySelector('form').addEventListener('submit', function() {
    updateHiddenInput();
    updateAvailabilityHiddenInput();
    updateEmailTemplateHiddenInputs();
});

// Availability Rules Builder
var availabilityRules = null;

// Initialize availability rules from template data
{{if .Data.Template}}{{if .Data.Template.AvailabilityRules}}
try {
    availabilityRules = {{.Data.Template.AvailabilityRules}};
} catch (e) {
    availabilityRules = null;
}
{{end}}{{end}}

function toggleCustomAvailability() {
    var checkbox = document.getElementById('use_custom_availability');
    var container = document.getElementById('availability-rules-container');

    if (checkbox.checked) {
        container.style.display = 'block';
        // Initialize default rules if none exist
        if (!availabilityRules || !availabilityRules.days) {
            availabilityRules = { enabled: true, days: {} };
        }
        availabilityRules.enabled = true;
    } else {
        container.style.display = 'none';
        if (availabilityRules) {
            availabilityRules.enabled = false;
        }
    }
    updateAvailabilityHiddenInput();
}

function updateAvailabilityRules() {
    if (!availabilityRules) {
        availabilityRules = { enabled: true, days: {} };
    }

    var days = {};
    for (var day = 0; day <= 6; day++) {
        var enabledCheckbox = document.querySelector('.day-enabled[data-day="' + day + '"]');
        var startInput = document.querySelector('.day-start[data-day="' + day + '"]');
        var endInput = document.querySelector('.day-end[data-day="' + day + '"]');
        var timeRangesDiv = enabledCheckbox.closest('.availability-day').querySelector('.day-time-ranges');

        if (enabledCheckbox.checked) {
            timeRangesDiv.style.display = 'block';
            days[day] = {
                enabled: true,
                start: startInput.value,
                end: endInput.value
            };
        } else {
            timeRangesDiv.style.display = 'none';
        }
    }

    availabilityRules.days = days;
    updateAvailabilityHiddenInput();
}

function updateAvailabilityHiddenInput() {
    var input = document.getElementById('availability_rules_json');
    var checkbox = document.getElementById('use_custom_availability');

    if (checkbox.checked && availabilityRules) {
        input.value = JSON.stringify(availabilityRules);
    } else {
        input.value = '';
    }
}

function initializeAvailabilityRules() {
    if (availabilityRules && availabilityRules.enabled && availabilityRules.days) {
        // Enable custom availability checkbox
        document.getElementById('use_custom_availability').checked = true;
        document.getElementById('availability-rules-container').style.display = 'block';

        // Set up each day
        for (var day in availabilityRules.days) {
            var dayData = availabilityRules.days[day];
            if (dayData.enabled) {
                var enabledCheckbox = document.querySelector('.day-enabled[data-day="' + day + '"]');
                var startInput = document.querySelector('.day-start[data-day="' + day + '"]');
                var endInput = document.querySelector('.day-end[data-day="' + day + '"]');
                var timeRangesDiv = enabledCheckbox.closest('.availability-day').querySelector('.day-time-ranges');

                enabledCheckbox.checked = true;
                startInput.value = dayData.start || '09:00';
                endInput.value = dayData.end || '17:00';
                timeRangesDiv.style.display = 'block';
            }
        }
    }
    updateAvailabilityHiddenInput();
}

// Email Templates Handler
var confirmationEmail = null;
var reminderEmail = null;

// Initialize email templates from template data
{{if .Data.Template}}{{if .Data.Template.ConfirmationEmail}}
try {
    confirmationEmail = JSON.parse({{.Data.Template.ConfirmationEmail}});
} catch (e) {
    confirmationEmail = null;
}
{{end}}{{end}}

{{if .Data.Template}}{{if .Data.Template.ReminderEmail}}
try {
    reminderEmail = JSON.parse({{.Data.Template.ReminderEmail}});
} catch (e) {
    reminderEmail = null;
}
{{end}}{{end}}

function initializeEmailTemplates() {
    if (confirmationEmail) {
        document.getElementById('confirmation_email_subject').value = confirmationEmail.subject || '';
        document.getElementById('confirmation_email_body').value = confirmationEmail.body || '';
    }
    if (reminderEmail) {
        document.getElementById('reminder_email_subject').value = reminderEmail.subject || '';
        document.getElementById('reminder_email_body').value = reminderEmail.body || '';
    }
}

function updateEmailTemplateHiddenInputs() {
    var confirmSubject = document.getElementById('confirmation_email_subject').value.trim();
    var confirmBody = document.getElementById('confirmation_email_body').value.trim();
    var reminderSubject = document.getElementById('reminder_email_subject').value.trim();
    var reminderBody = document.getElementById('reminder_email_body').value.trim();

    // Only set JSON if at least one field has content
    if (confirmSubject || confirmBody) {
        document.getElementById('confirmation_email_json').value = JSON.stringify({
            subject: confirmSubject,
            body: confirmBody
        });
    } else {
        document.getElementById('confirmation_email_json').value = '';
    }

    if (reminderSubject || reminderBody) {
        document.getElementById('reminder_email_json').value = JSON.stringify({
            subject: reminderSubject,
            body: reminderBody
        });
    } else {
        document.getElementById('reminder_email_json').value = '';
    }
}

// Initialize availability on page load (after renderQuestions)
document.addEventListener('DOMContentLoaded', function() {
    renderQuestions();
    initializeAvailabilityRules();
    initializeEmailTemplates();
});
</script>
{{end}}
