{{define "dashboard_template_form.html"}}
{{template "dashboard" .}}
{{end}}

{{define "content"}}
<div class="page-header">
    <a href="/dashboard/templates" class="back-btn" aria-label="Go back">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
            <line x1="19" y1="12" x2="5" y2="12"/>
            <polyline points="12 19 5 12 12 5"/>
        </svg>
    </a>
    <div>
        <h1 class="page-title">{{if .Data.IsNew}}New Meeting Type{{else}}Edit Meeting Type{{end}}</h1>
    </div>
</div>

<form method="POST" action="{{if .Data.IsNew}}/dashboard/templates{{else}}/dashboard/templates/{{.Data.Template.ID}}{{end}}" class="template-form">
    {{if not .Data.IsNew}}
    <input type="hidden" name="_method" value="PUT">
    {{end}}

    <section class="section">
        <div class="section-header">
            <h2 class="section-title">Basic Info</h2>
        </div>

        <div class="form-group">
            <label class="form-label" for="name">Name</label>
            <input type="text" id="name" name="name" class="form-input" required
                   value="{{if .Data.Template}}{{.Data.Template.Name}}{{end}}"
                   placeholder="e.g., Discovery Call">
        </div>

        <div class="form-group">
            <label class="form-label" for="description">Description</label>
            <textarea id="description" name="description" class="form-textarea" rows="3"
                      placeholder="What's this meeting about?">{{if .Data.Template}}{{.Data.Template.Description}}{{end}}</textarea>
        </div>

        <div class="form-group">
            <label class="form-label" for="slug">URL Slug</label>
            <input type="text" id="slug" name="slug" class="form-input" required pattern="[a-z0-9-]+"
                   value="{{if .Data.Template}}{{.Data.Template.Slug}}{{end}}"
                   placeholder="discovery-call">
            <p class="form-hint">Your booking link: {{$.BaseURL}}/m/{{$.Tenant.Slug}}/{{$.Host.Slug}}/<strong id="slug-preview">{{if .Data.Template}}{{.Data.Template.Slug}}{{else}}your-slug{{end}}</strong></p>
        </div>
    </section>

    <section class="section">
        <div class="section-header">
            <h2 class="section-title">Duration</h2>
            <p class="section-subtitle">How long should this meeting be?</p>
        </div>

        <div class="duration-chips" id="duration-chips">
            <label class="duration-chip {{if .Data.Template}}{{if contains .Data.Template.Durations 15}}selected{{end}}{{end}}">
                <input type="checkbox" name="durations" value="15" {{if .Data.Template}}{{if contains .Data.Template.Durations 15}}checked{{end}}{{end}}>
                15 min
            </label>
            <label class="duration-chip {{if .Data.Template}}{{if contains .Data.Template.Durations 30}}selected{{else}}{{end}}{{else}}selected{{end}}">
                <input type="checkbox" name="durations" value="30" {{if .Data.Template}}{{if contains .Data.Template.Durations 30}}checked{{end}}{{else}}checked{{end}}>
                30 min
            </label>
            <label class="duration-chip {{if .Data.Template}}{{if contains .Data.Template.Durations 45}}selected{{end}}{{end}}">
                <input type="checkbox" name="durations" value="45" {{if .Data.Template}}{{if contains .Data.Template.Durations 45}}checked{{end}}{{end}}>
                45 min
            </label>
            <label class="duration-chip {{if .Data.Template}}{{if contains .Data.Template.Durations 60}}selected{{end}}{{end}}">
                <input type="checkbox" name="durations" value="60" {{if .Data.Template}}{{if contains .Data.Template.Durations 60}}checked{{end}}{{end}}>
                60 min
            </label>
            <label class="duration-chip {{if .Data.Template}}{{if contains .Data.Template.Durations 90}}selected{{end}}{{end}}">
                <input type="checkbox" name="durations" value="90" {{if .Data.Template}}{{if contains .Data.Template.Durations 90}}checked{{end}}{{end}}>
                90 min
            </label>
        </div>
    </section>

    <section class="section">
        <div class="section-header">
            <h2 class="section-title">Scheduling</h2>
            <p class="section-subtitle">Set booking constraints</p>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label class="form-label" for="min_notice_minutes">Minimum Notice</label>
                <select id="min_notice_minutes" name="min_notice_minutes" class="form-select">
                    <option value="0" {{if .Data.Template}}{{if eq .Data.Template.MinNoticeMinutes 0}}selected{{end}}{{end}}>No minimum</option>
                    <option value="60" {{if .Data.Template}}{{if eq .Data.Template.MinNoticeMinutes 60}}selected{{end}}{{else}}selected{{end}}>1 hour</option>
                    <option value="120" {{if .Data.Template}}{{if eq .Data.Template.MinNoticeMinutes 120}}selected{{end}}{{end}}>2 hours</option>
                    <option value="240" {{if .Data.Template}}{{if eq .Data.Template.MinNoticeMinutes 240}}selected{{end}}{{end}}>4 hours</option>
                    <option value="1440" {{if .Data.Template}}{{if eq .Data.Template.MinNoticeMinutes 1440}}selected{{end}}{{end}}>1 day</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label" for="max_schedule_days">Scheduling Window</label>
                <select id="max_schedule_days" name="max_schedule_days" class="form-select">
                    <option value="7" {{if .Data.Template}}{{if eq .Data.Template.MaxScheduleDays 7}}selected{{end}}{{end}}>1 week</option>
                    <option value="14" {{if .Data.Template}}{{if eq .Data.Template.MaxScheduleDays 14}}selected{{end}}{{else}}selected{{end}}>2 weeks</option>
                    <option value="30" {{if .Data.Template}}{{if eq .Data.Template.MaxScheduleDays 30}}selected{{end}}{{end}}>1 month</option>
                    <option value="60" {{if .Data.Template}}{{if eq .Data.Template.MaxScheduleDays 60}}selected{{end}}{{end}}>2 months</option>
                    <option value="90" {{if .Data.Template}}{{if eq .Data.Template.MaxScheduleDays 90}}selected{{end}}{{end}}>3 months</option>
                </select>
            </div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label class="form-label" for="pre_buffer_minutes">Buffer Before</label>
                <select id="pre_buffer_minutes" name="pre_buffer_minutes" class="form-select">
                    <option value="0" {{if .Data.Template}}{{if eq .Data.Template.PreBufferMinutes 0}}selected{{end}}{{else}}selected{{end}}>None</option>
                    <option value="5" {{if .Data.Template}}{{if eq .Data.Template.PreBufferMinutes 5}}selected{{end}}{{end}}>5 min</option>
                    <option value="10" {{if .Data.Template}}{{if eq .Data.Template.PreBufferMinutes 10}}selected{{end}}{{end}}>10 min</option>
                    <option value="15" {{if .Data.Template}}{{if eq .Data.Template.PreBufferMinutes 15}}selected{{end}}{{end}}>15 min</option>
                    <option value="30" {{if .Data.Template}}{{if eq .Data.Template.PreBufferMinutes 30}}selected{{end}}{{end}}>30 min</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label" for="post_buffer_minutes">Buffer After</label>
                <select id="post_buffer_minutes" name="post_buffer_minutes" class="form-select">
                    <option value="0" {{if .Data.Template}}{{if eq .Data.Template.PostBufferMinutes 0}}selected{{end}}{{else}}selected{{end}}>None</option>
                    <option value="5" {{if .Data.Template}}{{if eq .Data.Template.PostBufferMinutes 5}}selected{{end}}{{end}}>5 min</option>
                    <option value="10" {{if .Data.Template}}{{if eq .Data.Template.PostBufferMinutes 10}}selected{{end}}{{end}}>10 min</option>
                    <option value="15" {{if .Data.Template}}{{if eq .Data.Template.PostBufferMinutes 15}}selected{{end}}{{end}}>15 min</option>
                    <option value="30" {{if .Data.Template}}{{if eq .Data.Template.PostBufferMinutes 30}}selected{{end}}{{end}}>30 min</option>
                </select>
            </div>
        </div>
    </section>

    <section class="section">
        <div class="section-header">
            <h2 class="section-title">Location</h2>
            <p class="section-subtitle">Where will the meeting take place?</p>
        </div>

        <div class="radio-cards" id="location-cards">
            <label class="radio-card {{if .Data.Template}}{{if eq .Data.Template.LocationType "google_meet"}}selected{{end}}{{else}}selected{{end}}">
                <input type="radio" name="location_type" value="google_meet" {{if .Data.Template}}{{if eq .Data.Template.LocationType "google_meet"}}checked{{end}}{{else}}checked{{end}}>
                <div class="radio-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                        <polygon points="23 7 16 12 23 17 23 7"/>
                        <rect x="1" y="5" width="15" height="14" rx="2" ry="2"/>
                    </svg>
                </div>
                <div class="radio-content">
                    <div class="radio-label">Google Meet</div>
                    <div class="radio-description">Auto-generate link</div>
                </div>
            </label>
            <label class="radio-card {{if .Data.Template}}{{if eq .Data.Template.LocationType "zoom"}}selected{{end}}{{end}}">
                <input type="radio" name="location_type" value="zoom" {{if .Data.Template}}{{if eq .Data.Template.LocationType "zoom"}}checked{{end}}{{end}}>
                <div class="radio-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                        <polygon points="23 7 16 12 23 17 23 7"/>
                        <rect x="1" y="5" width="15" height="14" rx="2" ry="2"/>
                    </svg>
                </div>
                <div class="radio-content">
                    <div class="radio-label">Zoom</div>
                    <div class="radio-description">Auto-generate link</div>
                </div>
            </label>
            <label class="radio-card {{if .Data.Template}}{{if eq .Data.Template.LocationType "phone"}}selected{{end}}{{end}}">
                <input type="radio" name="location_type" value="phone" {{if .Data.Template}}{{if eq .Data.Template.LocationType "phone"}}checked{{end}}{{end}}>
                <div class="radio-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                        <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72"/>
                    </svg>
                </div>
                <div class="radio-content">
                    <div class="radio-label">Phone Call</div>
                    <div class="radio-description">Guest provides number</div>
                </div>
            </label>
            <label class="radio-card {{if .Data.Template}}{{if eq .Data.Template.LocationType "custom"}}selected{{end}}{{end}}">
                <input type="radio" name="location_type" value="custom" {{if .Data.Template}}{{if eq .Data.Template.LocationType "custom"}}checked{{end}}{{end}}>
                <div class="radio-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                        <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
                        <circle cx="12" cy="10" r="3"/>
                    </svg>
                </div>
                <div class="radio-content">
                    <div class="radio-label">Custom</div>
                    <div class="radio-description">Specify location</div>
                </div>
            </label>
        </div>

        <div class="form-group" id="custom_location_group" style="{{if .Data.Template}}{{if or (eq .Data.Template.LocationType "phone") (eq .Data.Template.LocationType "custom")}}margin-top: 20px;{{else}}display:none{{end}}{{else}}display:none{{end}}">
            <label class="form-label" for="custom_location" id="custom_location_label">{{if .Data.Template}}{{if eq .Data.Template.LocationType "phone"}}Phone Number{{else}}Location Details{{end}}{{else}}Location Details{{end}}</label>
            <input type="text" id="custom_location" name="custom_location" class="form-input"
                   value="{{if .Data.Template}}{{.Data.Template.CustomLocation}}{{end}}"
                   placeholder="{{if .Data.Template}}{{if eq .Data.Template.LocationType "phone"}}Enter your phone number{{else}}Address or custom location{{end}}{{else}}Address or custom location{{end}}">
            <p class="form-hint" id="phone_help" style="{{if .Data.Template}}{{if eq .Data.Template.LocationType "phone"}}{{else}}display:none{{end}}{{else}}display:none{{end}}">The phone number will be displayed to invitees so they know where to call.</p>
        </div>
    </section>

    <section class="section">
        <div class="section-header">
            <h2 class="section-title">Calendar</h2>
        </div>

        <div class="form-group">
            <label class="form-label" for="calendar_id">Add Event To</label>
            <select id="calendar_id" name="calendar_id" class="form-select">
                <option value="">Select a calendar</option>
                {{range .Data.Calendars}}
                <option value="{{.ID}}" {{if $.Data.Template}}{{if eq $.Data.Template.CalendarID .ID}}selected{{end}}{{end}}>{{.Name}} ({{.Provider}})</option>
                {{end}}
            </select>
        </div>
    </section>

    {{if not .Data.IsNew}}{{if or .Data.TenantHosts (gt (len .Data.PooledHosts) 1)}}
    <section class="section">
        <div class="section-header">
            <h2 class="section-title">Team Members</h2>
            <p class="section-subtitle">Add team members to share this meeting type (pooled availability)</p>
        </div>

        {{template "pooled_hosts_partial.html" (toMap .Data)}}
    </section>
    {{end}}{{end}}

    <section class="section">
        <div class="section-header">
            <h2 class="section-title">Booking Settings</h2>
        </div>

        <div class="toggle-row">
            <div class="toggle-info">
                <h4>Require approval</h4>
                <p>Review booking requests before confirming</p>
            </div>
            <label class="toggle-switch">
                <input type="checkbox" name="requires_approval" {{if .Data.Template}}{{if .Data.Template.RequiresApproval}}checked{{end}}{{else}}checked{{end}}>
                <span class="toggle-slider"></span>
            </label>
        </div>
        {{if not .Data.IsNew}}
        <div class="toggle-row">
            <div class="toggle-info">
                <h4>Active</h4>
                <p>Allow people to book this meeting type</p>
            </div>
            <label class="toggle-switch">
                <input type="checkbox" name="is_active" {{if .Data.Template}}{{if .Data.Template.IsActive}}checked{{end}}{{else}}checked{{end}}>
                <span class="toggle-slider"></span>
            </label>
        </div>
        {{end}}
        <div class="toggle-row">
            <div class="toggle-info">
                <h4>Private</h4>
                <p>Hide from public listing, but still accessible via direct link</p>
            </div>
            <label class="toggle-switch">
                <input type="checkbox" name="is_private" {{if .Data.Template}}{{if .Data.Template.IsPrivate}}checked{{end}}{{end}}>
                <span class="toggle-slider"></span>
            </label>
        </div>
    </section>

    <section class="section">
        <div class="section-header">
            <h2 class="section-title">Availability</h2>
            <p class="section-subtitle">Restrict availability for this meeting type beyond your working hours</p>
        </div>

        <div class="toggle-row">
            <div class="toggle-info">
                <h4>Use custom availability</h4>
                <p>Override default working hours for this template</p>
            </div>
            <label class="toggle-switch">
                <input type="checkbox" id="use_custom_availability" onchange="toggleCustomAvailability()">
                <span class="toggle-slider"></span>
            </label>
        </div>

        <div id="availability-rules-container" style="display: none; margin-top: 20px;">
            <div class="availability-days" id="availability-days-container">
                <!-- Days will be rendered by JavaScript -->
            </div>
        </div>
        <input type="hidden" name="availability_rules" id="availability_rules_json">
    </section>

    <section class="section">
        <div class="section-header">
            <h2 class="section-title">Custom Questions</h2>
            <p class="section-subtitle">Add questions that invitees must answer when booking</p>
        </div>

        <div id="questions-container" class="questions-list">
            <!-- Questions will be rendered here by JavaScript -->
        </div>

        <button type="button" onclick="addQuestion()" class="btn btn-outline btn-add-question">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                <line x1="12" y1="5" x2="12" y2="19"/>
                <line x1="5" y1="12" x2="19" y2="12"/>
            </svg>
            Add Question
        </button>
        <input type="hidden" name="invitee_questions" id="invitee_questions_json">
    </section>

    <section class="section">
        <div class="section-header">
            <h2 class="section-title">Email Templates</h2>
            <p class="section-subtitle">Customize the emails sent to invitees. Leave blank to use defaults.</p>
        </div>

        <div class="email-template-group">
            <h3 class="subsection-title">Confirmation Email</h3>
            <div class="form-group">
                <label class="form-label" for="confirmation_email_subject">Subject</label>
                <input type="text" id="confirmation_email_subject" name="confirmation_email_subject" class="form-input"
                       value=""
                       placeholder="e.g., Confirmed: {{"{{meeting_name}}"}} with {{"{{host_name}}"}}">
            </div>

            <div class="form-group">
                <label class="form-label" for="confirmation_email_body">Body</label>
                <textarea id="confirmation_email_body" name="confirmation_email_body" class="form-textarea" rows="8"
                          placeholder="Hello {{"{{invitee_name}}"}},

Your meeting has been confirmed!

Meeting: {{"{{meeting_name}}"}}
With: {{"{{host_name}}"}}
When: {{"{{meeting_time}}"}}
Duration: {{"{{duration}}"}} minutes
Location: {{"{{location}}"}}

Need to make changes?
Cancel: {{"{{cancel_link}}"}}
Reschedule: {{"{{reschedule_link}}"}}

Best regards"></textarea>
            </div>
            <p class="form-hint">Available: <code>{{"{{invitee_name}}"}}</code>, <code>{{"{{host_name}}"}}</code>, <code>{{"{{meeting_name}}"}}</code>, <code>{{"{{meeting_time}}"}}</code>, <code>{{"{{duration}}"}}</code>, <code>{{"{{location}}"}}</code>, <code>{{"{{cancel_link}}"}}</code>, <code>{{"{{reschedule_link}}"}}</code></p>
        </div>

        <div class="email-template-group" style="margin-top: 24px; padding-top: 24px; border-top: 1px solid var(--gray-200);">
            <h3 class="subsection-title">Reminder Email</h3>
            <div class="form-group">
                <label class="form-label" for="reminder_email_subject">Subject</label>
                <input type="text" id="reminder_email_subject" name="reminder_email_subject" class="form-input"
                       value=""
                       placeholder="e.g., Reminder: {{"{{meeting_name}}"}} tomorrow with {{"{{host_name}}"}}">
            </div>

            <div class="form-group">
                <label class="form-label" for="reminder_email_body">Body</label>
                <textarea id="reminder_email_body" name="reminder_email_body" class="form-textarea" rows="8"
                          placeholder="Hello {{"{{invitee_name}}"}},

This is a reminder about your upcoming meeting:

Meeting: {{"{{meeting_name}}"}}
With: {{"{{host_name}}"}}
When: {{"{{meeting_time}}"}}
Duration: {{"{{duration}}"}} minutes
Location: {{"{{location}}"}}

Need to make changes?
Cancel: {{"{{cancel_link}}"}}
Reschedule: {{"{{reschedule_link}}"}}

Best regards"></textarea>
            </div>
        </div>
        <input type="hidden" name="confirmation_email" id="confirmation_email_json">
        <input type="hidden" name="reminder_email" id="reminder_email_json">
    </section>

    <div class="form-actions">
        <button type="submit" class="btn btn-primary">{{if .Data.IsNew}}Create Meeting Type{{else}}Save Changes{{end}}</button>
        {{if not .Data.IsNew}}
        <button type="button" class="btn btn-outline" onclick="document.getElementById('duplicate-form').submit()">Duplicate</button>
        {{end}}
        <a href="/dashboard/templates" class="btn btn-outline">Cancel</a>
    </div>
</form>

{{if not .Data.IsNew}}
<form id="duplicate-form" action="/dashboard/templates/{{.Data.Template.ID}}/duplicate" method="POST" style="display:none"></form>
{{end}}

<script>
// Slug preview
document.getElementById('slug').addEventListener('input', function() {
    document.getElementById('slug-preview').textContent = this.value || 'your-slug';
});

// Duration chip selection (multiple allowed)
document.querySelectorAll('#duration-chips .duration-chip input').forEach(function(input) {
    input.addEventListener('change', function() {
        this.closest('.duration-chip').classList.toggle('selected', this.checked);
    });
});

// Radio card selection (location)
document.querySelectorAll('#location-cards .radio-card input').forEach(function(input) {
    input.addEventListener('change', function() {
        document.querySelectorAll('#location-cards .radio-card').forEach(function(card) {
            card.classList.remove('selected');
        });
        this.closest('.radio-card').classList.add('selected');

        // Handle custom location visibility
        var customGroup = document.getElementById('custom_location_group');
        var label = document.getElementById('custom_location_label');
        var inputEl = document.getElementById('custom_location');
        var phoneHelp = document.getElementById('phone_help');

        if (this.value === 'phone') {
            customGroup.style.display = 'block';
            customGroup.style.marginTop = '20px';
            label.textContent = 'Phone Number';
            inputEl.placeholder = 'Enter your phone number';
            phoneHelp.style.display = 'block';
        } else if (this.value === 'custom') {
            customGroup.style.display = 'block';
            customGroup.style.marginTop = '20px';
            label.textContent = 'Location Details';
            inputEl.placeholder = 'Address or custom location';
            phoneHelp.style.display = 'none';
        } else {
            customGroup.style.display = 'none';
            phoneHelp.style.display = 'none';
        }
    });
});

// Custom Questions Builder
var questions = [];

// Initialize questions from template data
{{if .Data.Template}}{{if .Data.Template.InviteeQuestions}}
try {
    questions = {{.Data.Template.InviteeQuestions}};
} catch (e) {
    questions = [];
}
{{end}}{{end}}

function renderQuestions() {
    var container = document.getElementById('questions-container');
    container.innerHTML = '';

    questions.forEach(function(q, index) {
        var div = document.createElement('div');
        div.className = 'question-item';
        div.innerHTML = `
            <div class="question-header">
                <span class="question-number">Question ${index + 1}</span>
                <button type="button" onclick="removeQuestion(${index})" class="btn-icon btn-remove" aria-label="Remove question">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                        <polyline points="3 6 5 6 21 6"/>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                    </svg>
                </button>
            </div>
            <div class="form-group">
                <label class="form-label">Question Label *</label>
                <input type="text" class="form-input" value="${escapeHtml(q.label || '')}" onchange="updateQuestion(${index}, 'label', this.value)" placeholder="e.g., What company are you from?" required>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Field Name *</label>
                    <input type="text" class="form-input" value="${escapeHtml(q.field || '')}" onchange="updateQuestion(${index}, 'field', this.value)" placeholder="e.g., company_name" pattern="[a-z0-9_]+" required>
                    <p class="form-hint">Lowercase letters, numbers, underscores only</p>
                </div>
                <div class="form-group">
                    <label class="form-label">Type</label>
                    <select class="form-select" onchange="updateQuestion(${index}, 'type', this.value)">
                        <option value="text" ${q.type === 'text' ? 'selected' : ''}>Text (single line)</option>
                        <option value="textarea" ${q.type === 'textarea' ? 'selected' : ''}>Textarea (multi-line)</option>
                        <option value="select" ${q.type === 'select' ? 'selected' : ''}>Dropdown</option>
                    </select>
                </div>
            </div>
            <div class="form-group" id="options-group-${index}" style="${q.type === 'select' ? '' : 'display:none'}">
                <label class="form-label">Options (one per line)</label>
                <textarea class="form-textarea" rows="3" onchange="updateQuestion(${index}, 'options', this.value.split('\\n').filter(o => o.trim()))" placeholder="Option 1\nOption 2\nOption 3">${(q.options || []).join('\n')}</textarea>
            </div>
            <div class="toggle-row" style="padding: 0; border: none;">
                <div class="toggle-info">
                    <h4>Required</h4>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" ${q.required ? 'checked' : ''} onchange="updateQuestion(${index}, 'required', this.checked)">
                    <span class="toggle-slider"></span>
                </label>
            </div>
        `;
        container.appendChild(div);
    });

    updateHiddenInput();
}

function addQuestion() {
    questions.push({
        id: 'q' + Date.now(),
        field: '',
        label: '',
        type: 'text',
        required: false,
        options: []
    });
    renderQuestions();
}

function removeQuestion(index) {
    questions.splice(index, 1);
    renderQuestions();
}

function updateQuestion(index, key, value) {
    questions[index][key] = value;

    // Show/hide options field for select type
    if (key === 'type') {
        var optionsGroup = document.getElementById('options-group-' + index);
        if (optionsGroup) {
            optionsGroup.style.display = value === 'select' ? '' : 'none';
        }
    }

    updateHiddenInput();
}

function updateHiddenInput() {
    document.getElementById('invitee_questions_json').value = JSON.stringify(questions);
}

function escapeHtml(text) {
    var div = document.createElement('div');
    div.appendChild(document.createTextNode(text));
    return div.innerHTML;
}

// Update hidden input before form submission
document.querySelector('form').addEventListener('submit', function(e) {
    updateHiddenInput();
    updateAvailabilityHiddenInput();
    updateEmailTemplateHiddenInputs();

    // Validate intervals for overlaps
    if (!validateIntervals()) {
        e.preventDefault();
        // Scroll to the first error
        var firstError = document.querySelector('.interval-error[style*="display: block"]');
        if (firstError) {
            firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
        return false;
    }
});

// Availability Rules Builder
var availabilityRules = null;
var dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
var MAX_INTERVALS_PER_DAY = 2;

// Initialize availability rules from template data
{{if .Data.Template}}{{if .Data.Template.AvailabilityRules}}
try {
    availabilityRules = {{.Data.Template.AvailabilityRules}};
} catch (e) {
    availabilityRules = null;
}
{{end}}{{end}}

function toggleCustomAvailability() {
    var checkbox = document.getElementById('use_custom_availability');
    var container = document.getElementById('availability-rules-container');

    if (checkbox.checked) {
        container.style.display = 'block';
        // Initialize default rules if none exist
        if (!availabilityRules || !availabilityRules.days) {
            availabilityRules = { enabled: true, days: {} };
        }
        availabilityRules.enabled = true;
        renderAvailabilityDays();
    } else {
        container.style.display = 'none';
        if (availabilityRules) {
            availabilityRules.enabled = false;
        }
    }
    updateAvailabilityHiddenInput();
}

function renderAvailabilityDays() {
    var container = document.getElementById('availability-days-container');
    container.innerHTML = '';

    for (var day = 0; day <= 6; day++) {
        var dayData = (availabilityRules && availabilityRules.days && availabilityRules.days[day]) || null;
        var isEnabled = dayData && dayData.enabled;
        var intervals = [];

        if (dayData) {
            // Support new format (intervals array) or old format (single start/end)
            if (dayData.intervals && dayData.intervals.length > 0) {
                intervals = dayData.intervals;
            } else if (dayData.start && dayData.end) {
                intervals = [{ start: dayData.start, end: dayData.end }];
            }
        }

        // Default interval if day is enabled but no intervals exist
        if (isEnabled && intervals.length === 0) {
            intervals = [{ start: '09:00', end: '17:00' }];
        }

        var dayDiv = document.createElement('div');
        dayDiv.className = 'availability-day';
        dayDiv.setAttribute('data-day', day);

        var dayHeader = document.createElement('div');
        dayHeader.className = 'availability-day-header';
        dayHeader.innerHTML = `
            <label class="toggle-switch-inline">
                <input type="checkbox" class="day-enabled" data-day="${day}" onchange="toggleDay(${day})" ${isEnabled ? 'checked' : ''}>
                <span class="toggle-slider"></span>
            </label>
            <span class="day-name">${dayNames[day]}</span>
        `;
        dayDiv.appendChild(dayHeader);

        var timeRangesDiv = document.createElement('div');
        timeRangesDiv.className = 'availability-day-times';
        timeRangesDiv.id = 'day-time-ranges-' + day;
        timeRangesDiv.style.display = isEnabled ? 'flex' : 'none';

        // Render intervals
        var intervalsContainer = document.createElement('div');
        intervalsContainer.className = 'intervals-container';
        intervalsContainer.id = 'intervals-container-' + day;

        if (isEnabled && intervals.length > 0) {
            intervals.forEach(function(interval, idx) {
                intervalsContainer.appendChild(createIntervalElement(day, idx, interval.start, interval.end, intervals.length));
            });
        } else {
            // Default interval for when day gets enabled
            intervalsContainer.appendChild(createIntervalElement(day, 0, '09:00', '17:00', 1));
        }

        timeRangesDiv.appendChild(intervalsContainer);

        // Add interval button (shown only if less than MAX_INTERVALS_PER_DAY intervals)
        var addIntervalBtn = document.createElement('button');
        addIntervalBtn.type = 'button';
        addIntervalBtn.className = 'btn-icon btn-add-interval';
        addIntervalBtn.id = 'add-interval-btn-' + day;
        addIntervalBtn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>';
        addIntervalBtn.onclick = function(d) {
            return function() { addInterval(d); };
        }(day);
        addIntervalBtn.style.display = (isEnabled && intervals.length < MAX_INTERVALS_PER_DAY) ? 'inline-flex' : 'none';
        timeRangesDiv.appendChild(addIntervalBtn);

        // Error message div for overlap validation
        var errorDiv = document.createElement('div');
        errorDiv.className = 'interval-error';
        errorDiv.id = 'interval-error-' + day;
        errorDiv.style.display = 'none';
        timeRangesDiv.appendChild(errorDiv);

        dayDiv.appendChild(timeRangesDiv);
        container.appendChild(dayDiv);
    }
}

function createIntervalElement(day, index, start, end, totalIntervals) {
    var intervalDiv = document.createElement('div');
    intervalDiv.className = 'time-range';
    intervalDiv.setAttribute('data-day', day);
    intervalDiv.setAttribute('data-index', index);

    var startInput = document.createElement('input');
    startInput.type = 'time';
    startInput.className = 'form-input time-input interval-start';
    startInput.value = start;
    startInput.onchange = function() { updateAvailabilityRules(); };

    var toSpan = document.createElement('span');
    toSpan.className = 'time-separator';
    toSpan.textContent = 'to';

    var endInput = document.createElement('input');
    endInput.type = 'time';
    endInput.className = 'form-input time-input interval-end';
    endInput.value = end;
    endInput.onchange = function() { updateAvailabilityRules(); };

    intervalDiv.appendChild(startInput);
    intervalDiv.appendChild(toSpan);
    intervalDiv.appendChild(endInput);

    // Remove button (only show if more than 1 interval)
    if (totalIntervals > 1) {
        var removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.className = 'btn-icon btn-remove-interval';
        removeBtn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>';
        removeBtn.onclick = function(d, i) {
            return function() { removeInterval(d, i); };
        }(day, index);
        intervalDiv.appendChild(removeBtn);
    }

    return intervalDiv;
}

function toggleDay(day) {
    var checkbox = document.querySelector('.day-enabled[data-day="' + day + '"]');
    var timeRangesDiv = document.getElementById('day-time-ranges-' + day);
    var addIntervalBtn = document.getElementById('add-interval-btn-' + day);

    if (checkbox.checked) {
        timeRangesDiv.style.display = 'flex';
        // Show add interval button if less than max intervals
        var intervalsContainer = document.getElementById('intervals-container-' + day);
        var currentIntervals = intervalsContainer.querySelectorAll('.time-range').length;
        addIntervalBtn.style.display = currentIntervals < MAX_INTERVALS_PER_DAY ? 'inline-flex' : 'none';
    } else {
        timeRangesDiv.style.display = 'none';
    }

    updateAvailabilityRules();
}

function addInterval(day) {
    var intervalsContainer = document.getElementById('intervals-container-' + day);
    var currentIntervals = intervalsContainer.querySelectorAll('.time-range');
    var currentCount = currentIntervals.length;

    if (currentCount >= MAX_INTERVALS_PER_DAY) {
        return;
    }

    // Get smart default times based on first interval
    var firstInterval = currentIntervals[0];
    var firstStart = firstInterval.querySelector('.interval-start').value;
    var firstEnd = firstInterval.querySelector('.interval-end').value;

    var newStart, newEnd;
    // If first interval ends at or before 12:00, default to afternoon (13:00-17:00)
    if (firstEnd <= '12:00') {
        newStart = '13:00';
        newEnd = '17:00';
    } else {
        // Otherwise, start 1 hour after first interval ends, for 3 hours
        var endParts = firstEnd.split(':');
        var endHour = parseInt(endParts[0], 10);
        var endMin = parseInt(endParts[1], 10);
        var newStartHour = endHour + 1;
        var newEndHour = newStartHour + 3;
        if (newEndHour > 23) newEndHour = 23;
        newStart = String(newStartHour).padStart(2, '0') + ':' + String(endMin).padStart(2, '0');
        newEnd = String(newEndHour).padStart(2, '0') + ':' + String(endMin).padStart(2, '0');
    }

    var newIndex = currentCount;
    var newTotal = currentCount + 1;

    // Add new interval
    intervalsContainer.appendChild(createIntervalElement(day, newIndex, newStart, newEnd, newTotal));

    // Update remove buttons on existing intervals (they now need remove buttons)
    updateRemoveButtons(day);

    // Hide add interval button if we've reached max
    var addIntervalBtn = document.getElementById('add-interval-btn-' + day);
    if (newTotal >= MAX_INTERVALS_PER_DAY) {
        addIntervalBtn.style.display = 'none';
    }

    updateAvailabilityRules();
}

function removeInterval(day, index) {
    var intervalsContainer = document.getElementById('intervals-container-' + day);
    var intervals = intervalsContainer.querySelectorAll('.time-range');

    if (intervals.length <= 1) {
        return; // Can't remove the last interval
    }

    // Remove the interval at the given index
    intervals[index].remove();

    // Re-index remaining intervals and update remove buttons
    updateRemoveButtons(day);

    // Show add interval button
    var addIntervalBtn = document.getElementById('add-interval-btn-' + day);
    addIntervalBtn.style.display = 'inline-flex';

    updateAvailabilityRules();
}

function updateRemoveButtons(day) {
    var intervalsContainer = document.getElementById('intervals-container-' + day);
    var intervals = intervalsContainer.querySelectorAll('.time-range');
    var totalIntervals = intervals.length;

    intervals.forEach(function(interval, idx) {
        interval.setAttribute('data-index', idx);

        // Remove existing remove button if any
        var existingBtn = interval.querySelector('.btn-remove-interval');
        if (existingBtn) {
            existingBtn.remove();
        }

        // Add remove button if more than 1 interval
        if (totalIntervals > 1) {
            var removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.className = 'btn-icon btn-remove-interval';
            removeBtn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>';
            removeBtn.onclick = function(d, i) {
                return function() { removeInterval(d, i); };
            }(day, idx);
            interval.appendChild(removeBtn);
        }
    });
}

function updateAvailabilityRules() {
    if (!availabilityRules) {
        availabilityRules = { enabled: true, days: {} };
    }

    var days = {};
    for (var day = 0; day <= 6; day++) {
        var enabledCheckbox = document.querySelector('.day-enabled[data-day="' + day + '"]');

        if (enabledCheckbox && enabledCheckbox.checked) {
            var intervalsContainer = document.getElementById('intervals-container-' + day);
            var intervalElements = intervalsContainer.querySelectorAll('.time-range');
            var intervals = [];

            intervalElements.forEach(function(el) {
                var start = el.querySelector('.interval-start').value;
                var end = el.querySelector('.interval-end').value;
                if (start && end) {
                    intervals.push({ start: start, end: end });
                }
            });

            days[day] = {
                enabled: true,
                intervals: intervals
            };
        }
    }

    availabilityRules.days = days;
    updateAvailabilityHiddenInput();

    // Validate intervals on every change for immediate feedback
    validateIntervals();
}

function updateAvailabilityHiddenInput() {
    var input = document.getElementById('availability_rules_json');
    var checkbox = document.getElementById('use_custom_availability');

    if (checkbox.checked && availabilityRules) {
        input.value = JSON.stringify(availabilityRules);
    } else {
        input.value = '';
    }
}

// Interval Overlap Validation
// Overlap check: interval A overlaps B if A.start < B.end AND A.end > B.start
function intervalsOverlap(a, b) {
    return a.start < b.end && a.end > b.start;
}

function validateIntervals() {
    var checkbox = document.getElementById('use_custom_availability');
    if (!checkbox.checked) {
        return true; // No custom availability, no validation needed
    }

    var hasErrors = false;

    for (var day = 0; day <= 6; day++) {
        var errorDiv = document.getElementById('interval-error-' + day);
        var enabledCheckbox = document.querySelector('.day-enabled[data-day="' + day + '"]');

        if (!enabledCheckbox || !enabledCheckbox.checked) {
            if (errorDiv) errorDiv.style.display = 'none';
            continue;
        }

        var intervalsContainer = document.getElementById('intervals-container-' + day);
        var intervalElements = intervalsContainer.querySelectorAll('.time-range');
        var intervals = [];

        intervalElements.forEach(function(el) {
            var start = el.querySelector('.interval-start').value;
            var end = el.querySelector('.interval-end').value;
            if (start && end) {
                intervals.push({ start: start, end: end });
            }
        });

        // Check for overlaps between all pairs of intervals
        var overlapFound = false;
        for (var i = 0; i < intervals.length; i++) {
            for (var j = i + 1; j < intervals.length; j++) {
                if (intervalsOverlap(intervals[i], intervals[j])) {
                    overlapFound = true;
                    break;
                }
            }
            if (overlapFound) break;
        }

        if (overlapFound) {
            hasErrors = true;
            if (errorDiv) {
                errorDiv.textContent = 'Intervals overlap. Please adjust the times so they do not overlap.';
                errorDiv.style.display = 'block';
            }
        } else {
            if (errorDiv) {
                errorDiv.style.display = 'none';
            }
        }
    }

    return !hasErrors;
}

function initializeAvailabilityRules() {
    // Render the days first
    renderAvailabilityDays();

    if (availabilityRules && availabilityRules.enabled) {
        // Enable custom availability checkbox
        document.getElementById('use_custom_availability').checked = true;
        document.getElementById('availability-rules-container').style.display = 'block';
        // Re-render with the actual data
        renderAvailabilityDays();
    }
    updateAvailabilityHiddenInput();
}

// Email Templates Handler
var confirmationEmail = null;
var reminderEmail = null;

// Initialize email templates from template data
{{if .Data.Template}}{{if .Data.Template.ConfirmationEmail}}
try {
    confirmationEmail = JSON.parse({{.Data.Template.ConfirmationEmail}});
} catch (e) {
    confirmationEmail = null;
}
{{end}}{{end}}

{{if .Data.Template}}{{if .Data.Template.ReminderEmail}}
try {
    reminderEmail = JSON.parse({{.Data.Template.ReminderEmail}});
} catch (e) {
    reminderEmail = null;
}
{{end}}{{end}}

function initializeEmailTemplates() {
    if (confirmationEmail) {
        document.getElementById('confirmation_email_subject').value = confirmationEmail.subject || '';
        document.getElementById('confirmation_email_body').value = confirmationEmail.body || '';
    }
    if (reminderEmail) {
        document.getElementById('reminder_email_subject').value = reminderEmail.subject || '';
        document.getElementById('reminder_email_body').value = reminderEmail.body || '';
    }
}

function updateEmailTemplateHiddenInputs() {
    var confirmSubject = document.getElementById('confirmation_email_subject').value.trim();
    var confirmBody = document.getElementById('confirmation_email_body').value.trim();
    var reminderSubject = document.getElementById('reminder_email_subject').value.trim();
    var reminderBody = document.getElementById('reminder_email_body').value.trim();

    // Only set JSON if at least one field has content
    if (confirmSubject || confirmBody) {
        document.getElementById('confirmation_email_json').value = JSON.stringify({
            subject: confirmSubject,
            body: confirmBody
        });
    } else {
        document.getElementById('confirmation_email_json').value = '';
    }

    if (reminderSubject || reminderBody) {
        document.getElementById('reminder_email_json').value = JSON.stringify({
            subject: reminderSubject,
            body: reminderBody
        });
    } else {
        document.getElementById('reminder_email_json').value = '';
    }
}

// Initialize availability on page load (after renderQuestions)
document.addEventListener('DOMContentLoaded', function() {
    renderQuestions();
    initializeAvailabilityRules();
    initializeEmailTemplates();
});
</script>
{{end}}
