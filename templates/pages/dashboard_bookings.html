{{define "dashboard_bookings.html"}}
{{template "dashboard" .}}
{{end}}

{{define "content"}}
<div class="page-header">
    <h1>Bookings</h1>
    {{if gt .Data.ArchivableCount 0}}
    <button type="button" class="btn btn-outline"
        onclick="confirmBulkArchive({{.Data.ArchivableCount}})">
        Archive all cancelled/rejected ({{.Data.ArchivableCount}})
    </button>
    {{end}}
</div>

<div class="filter-bar">
    <div class="filter-buttons">
        <a href="/dashboard/bookings{{if .Data.ShowArchived}}?archived=true{{end}}" class="btn btn-sm {{if eq .Data.Filter ""}}btn-primary{{end}}">All ({{.Data.AllCount}})</a>
        <a href="/dashboard/bookings?filter=pending{{if .Data.ShowArchived}}&archived=true{{end}}" class="btn btn-sm {{if eq .Data.Filter "pending"}}btn-primary{{end}}">Pending ({{.Data.PendingCount}})</a>
        <a href="/dashboard/bookings?filter=confirmed{{if .Data.ShowArchived}}&archived=true{{end}}" class="btn btn-sm {{if eq .Data.Filter "confirmed"}}btn-primary{{end}}">Confirmed ({{.Data.ConfirmedCount}})</a>
        <a href="/dashboard/bookings?filter=cancelled{{if .Data.ShowArchived}}&archived=true{{end}}" class="btn btn-sm {{if eq .Data.Filter "cancelled"}}btn-primary{{end}}">Cancelled ({{.Data.CancelledCount}})</a>
    </div>
    <div class="filter-options">
        <label class="checkbox-label">
            <input type="checkbox" id="show-archived" {{if .Data.ShowArchived}}checked{{end}} onchange="toggleArchived(this)">
            Show archived
        </label>
    </div>
</div>

<script>
function toggleArchived(checkbox) {
    const url = new URL(window.location.href);
    if (checkbox.checked) {
        url.searchParams.set('archived', 'true');
    } else {
        url.searchParams.delete('archived');
    }
    window.location.href = url.toString();
}

function confirmBulkArchive(count) {
    if (confirm('Archive ' + count + ' cancelled/rejected booking' + (count > 1 ? 's' : '') + '?')) {
        // Create and submit a form
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/dashboard/bookings/archive-all';
        document.body.appendChild(form);
        form.submit();
    }
}
</script>

{{if .Data.Bookings}}
<table class="table bookings-table">
    <thead>
        <tr>
            <th>Date & Time</th>
            <th>Guest</th>
            <th>Meeting Type</th>
            <th>Duration</th>
            <th>Status</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        {{range .Data.Bookings}}
        <tr class="booking-row{{if .IsArchived}} archived{{end}}" id="booking-row-{{.ID}}" data-booking-id="{{.ID}}" onclick="openBookingModal('{{.ID}}')">
            <td>
                {{formatDate .StartTime}}<br>
                <small>{{formatTime .StartTime}} - {{formatTime .EndTime}}</small>
            </td>
            <td>
                {{.InviteeName}}<br>
                <small>{{.InviteeEmail}}</small>
                {{if .InviteePhone}}<br><small>{{.InviteePhone}}</small>{{end}}
            </td>
            <td>
                {{with index $.Data.Templates .TemplateID}}
                {{.Name}}
                {{end}}
            </td>
            <td>{{.Duration}} min</td>
            <td><span class="badge badge-{{.Status}}">{{.Status}}</span></td>
            <td class="actions-cell" onclick="event.stopPropagation()">
                {{if eq .Status "pending"}}
                <form action="/dashboard/bookings/{{.ID}}/approve" method="POST" style="display:inline">
                    <button type="submit" class="btn btn-sm btn-success">Approve</button>
                </form>
                <form action="/dashboard/bookings/{{.ID}}/reject" method="POST" style="display:inline">
                    <input type="hidden" name="reason" value="">
                    <button type="submit" class="btn btn-sm btn-danger">Reject</button>
                </form>
                {{else if eq .Status "confirmed"}}
                {{if .ConferenceLink}}
                <a href="{{.ConferenceLink}}" target="_blank" class="btn btn-sm">Join</a>
                {{end}}
                <form action="/dashboard/bookings/{{.ID}}/cancel" method="POST" style="display:inline">
                    <input type="hidden" name="reason" value="">
                    <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Cancel this booking?')">Cancel</button>
                </form>
                {{else if or (eq .Status "cancelled") (eq .Status "rejected")}}
                {{if .IsArchived}}
                <button type="button" class="btn btn-sm btn-outline"
                    hx-post="/dashboard/bookings/{{.ID}}/unarchive"
                    hx-target="#booking-row-{{.ID}}"
                    hx-swap="outerHTML"
                    hx-confirm="Unarchive this booking?">Unarchive</button>
                {{else}}
                <button type="button" class="btn btn-sm btn-outline"
                    hx-post="/dashboard/bookings/{{.ID}}/archive"
                    hx-target="#booking-row-{{.ID}}"
                    hx-swap="outerHTML"
                    hx-confirm="Archive this booking?">Archive</button>
                {{end}}
                {{end}}
            </td>
        </tr>
        {{end}}
    </tbody>
</table>

<!-- Modal container -->
<div id="booking-modal"></div>

<script>
function openBookingModal(bookingId) {
    fetch('/dashboard/bookings/' + bookingId + '/details')
        .then(response => response.text())
        .then(html => {
            document.getElementById('booking-modal').innerHTML = html;
            document.body.classList.add('modal-open');
        })
        .catch(error => {
            console.error('Error loading booking details:', error);
        });
}

function closeBookingModal(event) {
    if (event && event.target !== event.currentTarget) return;
    document.getElementById('booking-modal').innerHTML = '';
    document.body.classList.remove('modal-open');
}

// Close modal on Escape key
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        closeBookingModal();
    }
});
</script>
{{else}}
<div class="empty-state">
    <h3>No bookings found</h3>
    <p>{{if .Data.Filter}}No {{.Data.Filter}} bookings.{{else}}You haven't received any bookings yet.{{end}}</p>
</div>
{{end}}
{{end}}
